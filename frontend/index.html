<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zap An√¥nimo - Envie Mensagens pelo WhatsApp</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(to bottom, #f0f4f8 0%, #ffffff 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .navbar {
            max-width: 700px;
            margin: 0 auto 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 15px;
                flex-direction: column;
                gap: 15px;
            }
        }

        .navbar h1 {
            color: #1a1a1a;
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .whatsapp-icon {
            width: 32px;
            height: 32px;
            background: #25D366;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .whatsapp-icon svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        @media (max-width: 768px) {
            .navbar h1 {
                font-size: 20px;
            }
        }

        .navbar-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .navbar-buttons {
                width: 100%;
                flex-direction: column;
                gap: 8px;
            }
        }

        .user-email {
            color: #1a1a1a;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .user-email {
                max-width: 100%;
                width: 100%;
                text-align: center;
                font-size: 13px;
                order: 3;
                background: #f8fafc;
                padding: 8px;
                border-radius: 6px;
            }

            .credits-badge {
                order: 1;
                flex: 1;
                text-align: center;
            }

            .btn-nav {
                order: 2;
                flex: 1;
                width: 100%;
            }
        }

        .btn-nav {
            padding: 10px 24px;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-nav:hover {
            background: #4338ca;
            transform: translateY(-1px);
        }

        .credits-badge {
            background: #eef2ff;
            color: #4f46e5;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600;
        }

        .channel-btn {
            flex: 1;
            padding: 12px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .channel-btn:hover {
            border-color: #4f46e5;
        }

        .channel-btn.active {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        h2 {
            color: #1e293b;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .password-wrapper {
            position: relative;
        }

        .toggle-password {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            width: 20px;
            height: 20px;
            user-select: none;
            color: #666;
            transition: color 0.3s;
        }

        .toggle-password:hover {
            color: #25D366;
        }

        .toggle-password svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="password"],
        input.password-input {
            padding-right: 45px;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #25D366;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: Arial, sans-serif;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background-color: #4f46e5;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            background-color: #4338ca;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .btn:disabled {
            background-color: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-size: 17px;
            padding: 18px;
            font-weight: 700;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #5568d3 0%, #5e3a7f 100%);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 5px;
            text-align: center;
            display: none;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hint {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .info-box {
            background: #eef2ff;
            border-left: 4px solid #4f46e5;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .info-box p {
            margin: 5px 0;
            color: #475569;
            font-size: 14px;
        }

        .info-box strong {
            color: #4f46e5;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 40px;
            border-radius: 10px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            color: #666;
            font-weight: bold;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }

        .form-content {
            display: none;
        }

        .form-content.active {
            display: block;
        }

        .quantity-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .quantity-selector {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .quantity-option {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quantity-option:hover {
            border-color: #4f46e5;
        }

        .quantity-option.selected {
            border-color: #4f46e5;
            background-color: #eef2ff;
        }

        .quantity-option .amount {
            font-size: 18px;
            font-weight: bold;
            color: #4f46e5;
            line-height: 1.3;
        }

        .quantity-option .price {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item .date {
            font-size: 12px;
            color: #999;
        }

        .history-item .details {
            margin-top: 5px;
            color: #333;
        }

        .history-item.reply-item {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 4px solid #4f46e5;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .welcome-message {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        .welcome-message h2 {
            color: white;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .welcome-message p {
            font-size: 16px;
            opacity: 0.9;
        }

        .hidden {
            display: none !important;
        }

        /* Estilos para controles de √°udio */
        .audio-controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .audio-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-audio {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid #cbd5e1;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            color: #475569;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-audio:hover {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            border-color: #94a3b8;
        }

        .btn-audio.recording {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-color: #ef4444;
            color: #dc2626;
            animation: pulse-recording 1.5s infinite;
        }

        @keyframes pulse-recording {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }

        .btn-upload {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-color: #86efac;
            color: #166534;
        }

        .btn-upload:hover {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-color: #4ade80;
        }

        .audio-preview {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #7dd3fc;
            border-radius: 10px;
        }

        .audio-preview audio {
            flex: 1;
            height: 40px;
        }

        .btn-remove-audio {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #ef4444;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-remove-audio:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .recording-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 2px solid #fca5a5;
            border-radius: 10px;
            color: #dc2626;
            font-weight: 600;
        }

        .recording-dot {
            width: 12px;
            height: 12px;
            background: #ef4444;
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Player de √°udio nas respostas */
        .reply-audio-player {
            margin-top: 10px;
            padding: 10px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 8px;
        }

        .reply-audio-player audio {
            width: 100%;
            height: 36px;
        }

        .audio-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: #dbeafe;
            color: #1d4ed8;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Estilos para emoji picker */
        .message-input-container {
            position: relative;
        }

        .message-input-container textarea {
            width: 100%;
            padding-right: 50px;
        }

        .btn-emoji-toggle {
            position: absolute;
            right: 10px;
            top: 10px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .btn-emoji-toggle:hover {
            background: #f1f5f9;
            transform: scale(1.1);
        }

        .emoji-picker {
            margin-top: 10px;
            padding: 12px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 5px;
        }

        .emoji-grid span {
            font-size: 24px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .emoji-grid span:hover {
            background: #f1f5f9;
            transform: scale(1.2);
        }

        @media (max-width: 768px) {
            .emoji-grid {
                grid-template-columns: repeat(6, 1fr);
            }
            .emoji-grid span {
                font-size: 20px;
                padding: 6px;
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>
            <div class="whatsapp-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                </svg>
            </div>
            Zap An√¥nimo
        </h1>
        <div class="navbar-buttons" id="navbar-buttons">
            <button class="btn-nav" onclick="openLoginModal()">Entrar / Cadastrar</button>
        </div>
    </div>


    <div class="main-container" id="welcome-section">
        <div class="card full-width" style="text-align: center; max-width: 700px; margin: 0 auto;">

            <div style="margin-bottom: 40px;">
                <h2 style="font-size: 42px; color: #1e293b; font-weight: 700; margin-bottom: 15px; line-height: 1.2;">
                    Mensagens An√¥nimas<br>no WhatsApp
                </h2>
                <p style="font-size: 20px; color: #64748b; font-weight: 400; margin-top: 15px;">
                    Envie mensagens sem revelar sua identidade
                </p>
            </div>

            <div style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); padding: 40px; border-radius: 16px; margin: 40px 0; color: white; box-shadow: 0 10px 40px rgba(79, 70, 229, 0.2);">

                <div style="text-align: center; margin-bottom: 25px;">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">üì± WhatsApp</div>
                    <div style="font-size: 48px; font-weight: 700;">R$ 1,00</div>
                    <div style="font-size: 16px; opacity: 0.85;">por mensagem</div>
                </div>


                <div style="background: rgba(255, 255, 255, 0.15); padding: 20px; border-radius: 12px; backdrop-filter: blur(10px);">
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 15px; opacity: 0.95;">üí∞ Pacotes com Desconto (at√© 30% OFF)</div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 14px;">
                        <div style="text-align: left;">
                            <strong>5 mensagens</strong>
                            <div style="font-size: 13px; opacity: 0.9; margin-top: 3px;">R$ 4,75 <span style="opacity: 0.8;">(5% OFF)</span></div>
                        </div>
                        <div style="text-align: left;">
                            <strong>25 mensagens</strong>
                            <div style="font-size: 13px; opacity: 0.9; margin-top: 3px;">R$ 22,50 <span style="opacity: 0.8;">(10% OFF)</span></div>
                        </div>
                        <div style="text-align: left;">
                            <strong>50 mensagens</strong>
                            <div style="font-size: 13px; opacity: 0.9; margin-top: 3px;">R$ 40 <span style="opacity: 0.8;">(20% OFF)</span></div>
                        </div>
                        <div style="text-align: left;">
                            <strong>100 mensagens</strong>
                            <div style="font-size: 13px; opacity: 0.9; margin-top: 3px;">R$ 70 <span style="opacity: 0.8;">(30% OFF)</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="text-align: left; margin: 40px 0; background: #ffffff; border: 1px solid #e2e8f0; padding: 30px; border-radius: 12px;">
                <div style="display: flex; align-items: start; gap: 15px; margin-bottom: 20px;">
                    <div style="background: #4f46e5; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 18px; font-weight: 600;">1</div>
                    <div>
                        <h3 style="color: #1e293b; font-size: 16px; margin-bottom: 5px; font-weight: 600;">Informe o destinat√°rio</h3>
                        <p style="color: #64748b; font-size: 14px; margin: 0;">Digite o n√∫mero de WhatsApp para quem deseja enviar</p>
                    </div>
                </div>
                <div style="display: flex; align-items: start; gap: 15px; margin-bottom: 20px;">
                    <div style="background: #4f46e5; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 18px; font-weight: 600;">2</div>
                    <div>
                        <h3 style="color: #1e293b; font-size: 16px; margin-bottom: 5px; font-weight: 600;">Escreva sua mensagem</h3>
                        <p style="color: #64748b; font-size: 14px; margin: 0;">Crie o texto que ser√° enviado de forma an√¥nima</p>
                    </div>
                </div>
                <div style="display: flex; align-items: start; gap: 15px;">
                    <div style="background: #4f46e5; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 18px; font-weight: 600;">3</div>
                    <div>
                        <h3 style="color: #1e293b; font-size: 16px; margin-bottom: 5px; font-weight: 600;">Envie com seguran√ßa</h3>
                        <p style="color: #64748b; font-size: 14px; margin: 0;">Sua mensagem √© entregue instantaneamente e de forma totalmente an√¥nima</p>
                    </div>
                </div>
            </div>

            <button class="btn" onclick="openLoginModal()" style="font-size: 18px; padding: 18px; margin-top: 20px;">
                Come√ßar Agora
            </button>
            <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; color: white;">
                <p style="font-size: 18px; font-weight: 600; margin: 0 0 10px 0;">
                    üéÅ B√¥nus de Boas-Vindas
                </p>
                <p style="font-size: 15px; margin: 0; opacity: 0.95;">
                    Cadastre-se e ganhe:<br>
                    üì± <strong>5 mensagens WhatsApp gr√°tis!</strong>
                </p>
            </div>
        </div>
    </div>


    <div class="main-container hidden" id="main-section">

        <div class="card">
            <h2>Enviar Mensagem</h2>
            <p class="subtitle">Envie mensagens de forma an√¥nima e instant√¢nea</p>

            <div class="info-box">
                <p><strong>Custo:</strong> R$ 1,00 por mensagem</p>
                <p><strong>Saldo:</strong> üì± <span id="credits-send-whatsapp">0</span> mensagens</p>
            </div>

            <form id="sendForm" onsubmit="handleSend(event)">
                <div class="form-group">
                    <label for="phone">N√∫mero de Telefone</label>
                    <div style="display: flex; gap: 10px;">
                        <input
                            type="text"
                            value="+55"
                            readonly
                            style="width: 60px; background: #f0f0f0; color: #666;"
                        >
                        <input
                            type="tel"
                            id="phone"
                            placeholder="11999999999"
                            required
                            pattern="[0-9]{10,11}"
                            maxlength="11"
                            style="flex: 1;"
                        >
                    </div>
                    <p class="hint">Digite apenas DDD + n√∫mero (ex: 11999999999)</p>
                </div>

                <div class="form-group">
                    <label for="message">Mensagem</label>
                    <div class="message-input-container">
                        <textarea
                            id="message"
                            placeholder="Digite sua mensagem aqui..."
                            maxlength="65536"
                        ></textarea>
                        <button type="button" class="btn-emoji-toggle" onclick="toggleEmojiPicker()">üòä</button>
                    </div>
                    <div id="emoji-picker" class="emoji-picker" style="display: none;">
                        <div class="emoji-grid">
                            <span onclick="addEmoji('üòÄ')">üòÄ</span>
                            <span onclick="addEmoji('üòÇ')">üòÇ</span>
                            <span onclick="addEmoji('üòç')">üòç</span>
                            <span onclick="addEmoji('ü•∞')">ü•∞</span>
                            <span onclick="addEmoji('üòò')">üòò</span>
                            <span onclick="addEmoji('üòé')">üòé</span>
                            <span onclick="addEmoji('ü§î')">ü§î</span>
                            <span onclick="addEmoji('üò¢')">üò¢</span>
                            <span onclick="addEmoji('üò≠')">üò≠</span>
                            <span onclick="addEmoji('üò°')">üò°</span>
                            <span onclick="addEmoji('üëç')">üëç</span>
                            <span onclick="addEmoji('üëé')">üëé</span>
                            <span onclick="addEmoji('üëè')">üëè</span>
                            <span onclick="addEmoji('üôè')">üôè</span>
                            <span onclick="addEmoji('üí™')">üí™</span>
                            <span onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
                            <span onclick="addEmoji('üíî')">üíî</span>
                            <span onclick="addEmoji('üî•')">üî•</span>
                            <span onclick="addEmoji('‚ú®')">‚ú®</span>
                            <span onclick="addEmoji('üéâ')">üéâ</span>
                            <span onclick="addEmoji('üíØ')">üíØ</span>
                            <span onclick="addEmoji('ü§£')">ü§£</span>
                            <span onclick="addEmoji('üòÖ')">üòÖ</span>
                            <span onclick="addEmoji('üòä')">üòä</span>
                            <span onclick="addEmoji('üôÑ')">üôÑ</span>
                            <span onclick="addEmoji('üòè')">üòè</span>
                            <span onclick="addEmoji('üò¥')">üò¥</span>
                            <span onclick="addEmoji('ü§ó')">ü§ó</span>
                            <span onclick="addEmoji('ü§´')">ü§´</span>
                            <span onclick="addEmoji('ü§≠')">ü§≠</span>
                        </div>
                    </div>
                    <small style="color: #64748b; font-size: 12px;">M√°ximo: 65.536 caracteres</small>
                </div>

                <!-- Controles de √Åudio -->
                <div class="form-group">
                    <label>Ou grave um √°udio</label>
                    <div class="audio-controls">
                        <div class="audio-buttons">
                            <button type="button" class="btn-audio" id="record-btn" onclick="toggleRecording()">
                                <span class="record-icon">üé§</span>
                                <span id="record-btn-text">Gravar</span>
                            </button>
                        </div>

                        <!-- Preview do √°udio -->
                        <div id="audio-preview-container" class="audio-preview" style="display: none;">
                            <audio id="audio-preview" controls></audio>
                            <button type="button" class="btn-remove-audio" onclick="removeAudio()">‚úï</button>
                        </div>

                        <!-- Indicador de grava√ß√£o -->
                        <div id="recording-indicator" class="recording-indicator" style="display: none;">
                            <span class="recording-dot"></span>
                            <span id="recording-time">00:00</span>
                        </div>
                    </div>
                    <small style="color: #64748b; font-size: 12px;">Clique em gravar, fale e clique novamente para parar</small>
                </div>

                <button type="submit" class="btn" id="send-btn">Enviar Mensagem</button>
            </form>

            <div id="whatsapp-status-indicator" class="message" style="display: none;"></div>
            <div id="send-message" class="message"></div>
        </div>


        <div class="card">
            <h2>Comprar Mensagens</h2>
            <p class="subtitle">R$ 1,00 por mensagem</p>

            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px; font-weight: 600; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);">
                Promo√ß√£o: At√© 30% de desconto em pacotes
            </div>

            <div class="quantity-selector" id="quantity-selector">
                <div class="quantity-option" onclick="selectQuantity(5)">
                    <div class="amount">5 mensagens</div>
                    <div class="price">R$ 4,75 <small style="color: #333;">(5% OFF)</small></div>
                </div>
                <div class="quantity-option" onclick="selectQuantity(25)">
                    <div class="amount">25 mensagens</div>
                    <div class="price">R$ 22,50 <small style="color: #333;">(10% OFF)</small></div>
                </div>
                <div class="quantity-option" onclick="selectQuantity(50)">
                    <div class="amount">50 mensagens</div>
                    <div class="price">R$ 40 <small style="color: #333;">(20% OFF)</small></div>
                </div>
                <div class="quantity-option" onclick="selectQuantity(100)">
                    <div class="amount">100 mensagens</div>
                    <div class="price">R$ 70 <small style="color: #333;">(30% OFF)</small></div>
                </div>
            </div>

            <div class="form-group">
                <label for="custom-quantity">Ou digite a quantidade:</label>
                <input
                    type="number"
                    id="custom-quantity"
                    min="1"
                    placeholder="Quantidade de mensagens"
                >
            </div>

            <button class="btn btn-secondary" onclick="buyCredits()" id="buy-btn">Comprar Mensagens</button>

            <div id="buy-message" class="message"></div>
        </div>

     
        <div class="card">
            <h2>Mensagens Enviadas</h2>
            <p class="subtitle">Hist√≥rico de mensagens que voc√™ enviou</p>
            <div class="history-list" id="history-list">
                <p style="text-align: center; color: #999;">Carregando...</p>
            </div>
        </div>


        <div class="card">
            <h2>Respostas Recebidas</h2>
            <p class="subtitle">Respostas √†s suas mensagens an√¥nimas</p>
            <div class="history-list" id="replies-list">
                <p style="text-align: center; color: #999;">Carregando...</p>
            </div>
        </div>
    </div>


    <div id="forgotPasswordModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeForgotPasswordModal()">&times;</span>
            <h2 style="color: #1e293b; margin-bottom: 10px;">Recuperar Senha</h2>
            <p style="color: #64748b; margin-bottom: 30px;">Digite seu email para receber o link de recupera√ß√£o</p>

            <form onsubmit="handleForgotPassword(event)">
                <div class="form-group">
                    <label for="forgot-email">Email</label>
                    <input type="email" id="forgot-email" required>
                </div>

                <button type="submit" class="btn" id="forgot-btn">Enviar Link de Recupera√ß√£o</button>
            </form>

            <div id="forgot-message" class="message"></div>

            <div style="text-align: center; margin-top: 15px;">
                <a href="#" onclick="backToLogin(event)" style="color: #4f46e5; text-decoration: none; font-size: 14px;">Voltar ao Login</a>
            </div>
        </div>
    </div>


    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLoginModal()">&times;</span>
            <h2 style="color: #1e293b; margin-bottom: 10px;">Bem-vindo</h2>
            <p style="color: #64748b; margin-bottom: 30px;">Fa√ßa login ou crie sua conta</p>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('login')">Login</div>
                <div class="tab" onclick="switchTab('register')">Cadastro</div>
            </div>

       
            <div id="login-form" class="form-content active">
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" required>
                    </div>

                    <div class="form-group">
                        <label for="login-password">Senha</label>
                        <div class="password-wrapper">
                            <input type="password" id="login-password" class="password-input" required>
                            <span class="toggle-password" onclick="togglePassword('login-password')">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                </svg>
                            </span>
                        </div>
                    </div>

                    <button type="submit" class="btn" id="login-btn">Entrar</button>
                </form>
                <div style="text-align: center; margin-top: 15px;">
                    <a href="#" onclick="openForgotPasswordModal(event)" style="color: #4f46e5; text-decoration: none; font-size: 14px;">Esqueceu sua senha?</a>
                </div>
            </div>

            <div id="register-form" class="form-content">
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 18px; margin-bottom: 20px; border-radius: 8px; color: white;">
                    <p style="font-size: 15px; margin: 0 0 8px 0; font-weight: 600;">
                        üéÅ B√¥nus de Boas-Vindas
                    </p>
                    <p style="font-size: 14px; margin: 0; opacity: 0.95;">
                        üì± <strong>5 mensagens WhatsApp gr√°tis!</strong>
                    </p>
                </div>
                <form onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label for="register-email">Email</label>
                        <input type="email" id="register-email" required>
                    </div>

                    <div class="form-group">
                        <label for="register-password">Senha</label>
                        <div class="password-wrapper">
                            <input type="password" id="register-password" class="password-input" required minlength="6">
                            <span class="toggle-password" onclick="togglePassword('register-password')">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                </svg>
                            </span>
                        </div>
                        <p class="hint">M√≠nimo 6 caracteres</p>
                    </div>

                    <div class="form-group">
                        <label for="register-password-confirm">Confirmar Senha</label>
                        <div class="password-wrapper">
                            <input type="password" id="register-password-confirm" class="password-input" required>
                            <span class="toggle-password" onclick="togglePassword('register-password-confirm')">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                </svg>
                            </span>
                        </div>
                    </div>

                    <button type="submit" class="btn" id="register-btn">Criar Conta</button>
                </form>
            </div>

            <div id="modal-message" class="message"></div>
        </div>
    </div>


    <script src="config.js"></script>
    <script src="api.js"></script>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

    <script>
        let token = localStorage.getItem('token');
        let user = JSON.parse(localStorage.getItem('user') || 'null');
        let selectedQuantity = 0;
        let selectedChannel = 'whatsapp';
        let selectedCreditType = 'whatsapp';
        let repliesPollingInterval = null;
        let socket = null;

        // Vari√°veis para grava√ß√£o de √°udio
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let recordingStartTime = null;
        let recordingTimer = null;
        let currentAudioBlob = null;
        let currentAudioBase64 = null;
        let currentAudioMimetype = null;

        // Fun√ß√µes de √°udio
        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                // Preferir formato OGG para melhor compatibilidade com WhatsApp
                const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
                    ? 'audio/webm;codecs=opus'
                    : 'audio/webm';

                mediaRecorder = new MediaRecorder(stream, { mimeType });
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    processAudioBlob(audioBlob, mimeType);

                    // Parar todas as tracks do stream
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                recordingStartTime = Date.now();

                // Atualizar UI
                const recordBtn = document.getElementById('record-btn');
                const recordBtnText = document.getElementById('record-btn-text');
                const recordingIndicator = document.getElementById('recording-indicator');

                recordBtn.classList.add('recording');
                recordBtnText.textContent = 'Parar';
                recordingIndicator.style.display = 'flex';

                // Iniciar timer
                updateRecordingTime();
                recordingTimer = setInterval(updateRecordingTime, 1000);

            } catch (error) {
                console.error('Erro ao acessar microfone:', error);
                showMessage('send-message', 'N√£o foi poss√≠vel acessar o microfone. Verifique as permiss√µes.', 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;

                // Limpar timer
                if (recordingTimer) {
                    clearInterval(recordingTimer);
                    recordingTimer = null;
                }

                // Atualizar UI
                const recordBtn = document.getElementById('record-btn');
                const recordBtnText = document.getElementById('record-btn-text');
                const recordingIndicator = document.getElementById('recording-indicator');

                recordBtn.classList.remove('recording');
                recordBtnText.textContent = 'Gravar';
                recordingIndicator.style.display = 'none';
            }
        }

        function updateRecordingTime() {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const seconds = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('recording-time').textContent = `${minutes}:${seconds}`;
        }

        function handleAudioUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validar tamanho (16MB)
            if (file.size > 16 * 1024 * 1024) {
                showMessage('send-message', 'Arquivo muito grande. M√°ximo: 16MB', 'error');
                event.target.value = '';
                return;
            }

            // Validar tipo
            if (!file.type.startsWith('audio/')) {
                showMessage('send-message', 'Por favor, selecione um arquivo de √°udio v√°lido.', 'error');
                event.target.value = '';
                return;
            }

            processAudioBlob(file, file.type);
        }

        function processAudioBlob(blob, mimetype) {
            currentAudioBlob = blob;
            currentAudioMimetype = mimetype;

            // Converter para base64
            const reader = new FileReader();
            reader.onloadend = () => {
                // Remover o prefixo data:audio/...;base64,
                currentAudioBase64 = reader.result.split(',')[1];

                // Mostrar preview
                const previewContainer = document.getElementById('audio-preview-container');
                const audioPreview = document.getElementById('audio-preview');

                audioPreview.src = URL.createObjectURL(blob);
                previewContainer.style.display = 'flex';
            };
            reader.readAsDataURL(blob);
        }

        function removeAudio() {
            currentAudioBlob = null;
            currentAudioBase64 = null;
            currentAudioMimetype = null;

            const previewContainer = document.getElementById('audio-preview-container');
            const audioPreview = document.getElementById('audio-preview');

            previewContainer.style.display = 'none';
            audioPreview.src = '';
        }

        // Fun√ß√µes do emoji picker
        function toggleEmojiPicker() {
            const picker = document.getElementById('emoji-picker');
            picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
        }

        function addEmoji(emoji) {
            const textarea = document.getElementById('message');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;

            textarea.value = text.substring(0, start) + emoji + text.substring(end);
            textarea.focus();
            textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const toggle = event.currentTarget;

            if (input.type === 'password') {
                input.type = 'text';
                toggle.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>';
            } else {
                input.type = 'password';
                toggle.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>';
            }
        }

        function updateUI() {
            const navButtons = document.getElementById('navbar-buttons');
            const welcomeSection = document.getElementById('welcome-section');
            const mainSection = document.getElementById('main-section');

            if (token && user) {
                navButtons.innerHTML = `
                    <span class="user-email">${user.email}</span>
                    <button class="btn-nav" onclick="logout()">Sair</button>
                `;
                welcomeSection.classList.add('hidden');
                mainSection.classList.remove('hidden');
                loadUserData();
                loadHistory();
                loadReplies();
                connectSocket();
                startRepliesPolling();
                checkWhatsAppStatus(); 
            } else {
                navButtons.innerHTML = `
                    <button class="btn-nav" onclick="openLoginModal()">Entrar / Cadastrar</button>
                `;
                welcomeSection.classList.remove('hidden');
                mainSection.classList.add('hidden');
                disconnectSocket(); 
                stopRepliesPolling();
            }
        }

        async function loadUserData() {
            if (!token) return;

            try {
                const response = await API.get('/api/user/profile', token);

                if (response.status === 401) {
                    logout();
                    return;
                }

                const data = await response.json();
                if (data.success) {
                    updateCreditsDisplay(data.user.whatsapp_credits, data.user.sms_credits);
                }
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
            }
        }

        function updateCreditsDisplay(whatsappCredits, smsCredits) {
            document.getElementById('credits-send-whatsapp').textContent = whatsappCredits;
        }

        async function checkWhatsAppStatus() {
            const indicator = document.getElementById('whatsapp-status-indicator');
            try {
                const response = await API.get('/api/whatsapp/available', token);
                const data = await response.json();

                if (data.success && data.available) {
                    indicator.style.display = 'none';
                } else {
                    indicator.style.display = 'block';
                    indicator.className = 'message error';
                    indicator.innerHTML = 'Sistema temporariamente offline. Tente novamente em alguns minutos.';
                }
            } catch (error) {
                indicator.style.display = 'block';
                indicator.className = 'message error';
                indicator.innerHTML = 'Erro ao verificar status do WhatsApp';
            }
        }

        function hideWhatsAppStatus() {
            const indicator = document.getElementById('whatsapp-status-indicator');
            indicator.style.display = 'none';
        }

        async function loadHistory() {
            if (!token) return;

            try {
                const response = await API.get('/api/messages', token);

                const data = await response.json();
                const historyList = document.getElementById('history-list');

                if (data.success && data.messages.length > 0) {
                    historyList.innerHTML = data.messages.map(msg => {
                        const hasReply = msg.has_reply ? '<span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px;">Respondida</span>' : '';
                        return `
                            <div class="history-item">
                                <div class="date">${new Date(msg.created_at).toLocaleString('pt-BR')}${hasReply}</div>
                                <div class="details">
                                    <strong>Para:</strong> ${msg.phone}<br>
                                    <strong>Mensagem:</strong> ${msg.message}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    historyList.innerHTML = '<p style="text-align: center; color: #999;">Nenhuma mensagem enviada ainda</p>';
                }
            } catch (error) {
                console.error('Erro ao carregar hist√≥rico:', error);
            }
        }

        async function loadReplies() {
            if (!token) return;

            const repliesList = document.getElementById('replies-list');

            try {
                const response = await API.get('/api/replies', token);

                const data = await response.json();

                if (data.success && data.replies && data.replies.length > 0) {
                    repliesList.innerHTML = data.replies.map(reply => {
                        // Verificar se tem √°udio
                        const hasAudio = reply.audio_url && reply.audio_url.length > 0;
                        const audioPlayer = hasAudio ? `
                            <div class="reply-audio-player">
                                <span class="audio-badge">üé§ Mensagem de √°udio</span>
                                <audio controls src="${reply.audio_url}" preload="metadata"></audio>
                            </div>
                        ` : '';

                        return `
                            <div class="history-item reply-item">
                                <div class="date">
                                    <span style="background: #4f46e5; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-right: 8px;">Nova</span>
                                    ${hasAudio ? '<span class="audio-badge" style="margin-right: 8px;">üé§ √Åudio</span>' : ''}
                                    ${new Date(reply.created_at).toLocaleString('pt-BR')}
                                </div>
                                <div class="details">
                                    <strong>De:</strong> ${reply.from_phone}<br>
                                    <strong>Resposta:</strong> ${reply.message}
                                </div>
                                ${audioPlayer}
                                ${reply.original_message ? `<div style="margin-top: 10px; padding: 10px; background: #f8fafc; border-radius: 6px; border-left: 3px solid #cbd5e1;">
                                    <small style="color: #64748b;">Em resposta a:</small><br>
                                    <span style="color: #475569; font-size: 13px;">${reply.original_message}</span>
                                </div>` : ''}
                            </div>
                        `;
                    }).join('');
                } else {
                    repliesList.innerHTML = `
                        <div style="text-align: center; padding: 30px 20px;">
                            <div style="font-size: 48px; margin-bottom: 15px;">üì≠</div>
                            <p style="color: #64748b; margin: 0;">Nenhuma resposta recebida ainda</p>
                            <p style="color: #94a3b8; font-size: 13px; margin-top: 8px;">Quando algu√©m responder suas mensagens, aparecer√° aqui</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar respostas:', error);
                repliesList.innerHTML = `
                    <div style="text-align: center; padding: 30px 20px;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üì≠</div>
                        <p style="color: #64748b; margin: 0;">Nenhuma resposta recebida ainda</p>
                        <p style="color: #94a3b8; font-size: 13px; margin-top: 8px;">Quando algu√©m responder suas mensagens, aparecer√° aqui</p>
                    </div>
                `;
            }
        }

        function openLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
        }

        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
        }

        function openForgotPasswordModal(event) {
            event.preventDefault();
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('forgotPasswordModal').style.display = 'block';
        }

        function closeForgotPasswordModal() {
            document.getElementById('forgotPasswordModal').style.display = 'none';
        }

        function backToLogin(event) {
            event.preventDefault();
            document.getElementById('forgotPasswordModal').style.display = 'none';
            document.getElementById('loginModal').style.display = 'block';
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.form-content').forEach(f => f.classList.remove('active'));

            if (tab === 'login') {
                document.querySelector('.tab:first-child').classList.add('active');
                document.getElementById('login-form').classList.add('active');
            } else {
                document.querySelector('.tab:last-child').classList.add('active');
                document.getElementById('register-form').classList.add('active');
            }

            document.getElementById('modal-message').style.display = 'none';
        }


        async function handleLogin(event) {
            event.preventDefault();

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('login-btn');

            btn.disabled = true;
            btn.textContent = 'Entrando...';

            try {
                const response = await API.post('/api/login', { email, password });

                const data = await response.json();

                if (data.success) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    token = data.token;
                    user = data.user;
                    showModalMessage('Login realizado com sucesso!', 'success');
                    setTimeout(() => {
                        closeLoginModal();
                        updateUI();
                    }, 1000);
                } else {
                    showModalMessage(data.error, 'error');
                }
            } catch (error) {
                showModalMessage('Erro ao fazer login: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Entrar';
            }
        }

        async function handleForgotPassword(event) {
            event.preventDefault();

            const email = document.getElementById('forgot-email').value;
            const btn = document.getElementById('forgot-btn');
            const messageDiv = document.getElementById('forgot-message');

            btn.disabled = true;
            btn.textContent = 'Enviando...';
            messageDiv.style.display = 'none';

            try {
                const response = await API.post('/api/forgot-password', { email });

                const data = await response.json();

                if (data.success) {
                    messageDiv.textContent = 'Link de recupera√ß√£o enviado! Verifique seu email.';
                    messageDiv.className = 'message success';
                    messageDiv.style.display = 'block';
                    document.getElementById('forgot-email').value = '';
                } else {
                    messageDiv.textContent = data.error || 'Erro ao enviar link de recupera√ß√£o';
                    messageDiv.className = 'message error';
                    messageDiv.style.display = 'block';
                }
            } catch (error) {
                messageDiv.textContent = 'Erro ao processar solicita√ß√£o: ' + error.message;
                messageDiv.className = 'message error';
                messageDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Enviar Link de Recupera√ß√£o';
            }
        }

        async function handleRegister(event) {
            event.preventDefault();

            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const passwordConfirm = document.getElementById('register-password-confirm').value;
            const btn = document.getElementById('register-btn');

            if (password !== passwordConfirm) {
                showModalMessage('As senhas n√£o coincidem', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Criando conta...';

            try {
                const response = await API.post('/api/register', { email, password });

                const data = await response.json();

                if (data.success) {
                    const email = document.getElementById('register-email').value;

                    document.getElementById('register-form').querySelector('form').reset();


                    closeLoginModal();


                    alert(`‚úÖ CONTA CRIADA COM SUCESSO!\n\nüìß Um email de verifica√ß√£o foi enviado para:\n${email}\n\n‚ö†Ô∏è IMPORTANTE:\n‚Ä¢ Verifique sua caixa de entrada (e spam)\n‚Ä¢ Clique no link de verifica√ß√£o\n‚Ä¢ S√≥ ent√£o voc√™ poder√° fazer login\n\nSem a verifica√ß√£o do email, voc√™ N√ÉO conseguir√° acessar o sistema.`);


                    openLoginModal();
                    switchTab('login');
                    showModalMessage('Verifique seu email para ativar sua conta antes de fazer login.', 'success');
                } else {
                    showModalMessage(data.error, 'error');
                }
            } catch (error) {
                showModalMessage('Erro ao criar conta: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Criar Conta';
            }
        }


        async function handleSend(event) {
            event.preventDefault();

            const phoneNumber = document.getElementById('phone').value;
            const fullPhone = '+55' + phoneNumber;
            const message = document.getElementById('message').value;
            const btn = document.getElementById('send-btn');

            // Verificar se tem √°udio ou mensagem
            const hasAudio = currentAudioBase64 !== null;
            const hasMessage = message && message.trim().length > 0;

            if (!hasAudio && !hasMessage) {
                showMessage('send-message', 'Por favor, digite uma mensagem ou grave/envie um √°udio.', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = hasAudio ? 'Enviando √°udio...' : 'Enviando...';

            try {
                let response;
                let data;

                if (hasAudio) {
                    // Enviar √°udio
                    console.log('[DEBUG] Enviando √°udio...');
                    console.log('[DEBUG] Mimetype:', currentAudioMimetype);
                    console.log('[DEBUG] Base64 length:', currentAudioBase64 ? currentAudioBase64.length : 0);
                    console.log('[DEBUG] Phone:', fullPhone);

                    response = await API.post('/api/send-whatsapp-audio', {
                        phone: fullPhone,
                        audioBase64: currentAudioBase64,
                        mimetype: currentAudioMimetype,
                        caption: message || ''
                    }, token);

                    console.log('[DEBUG] Response status:', response.status);
                } else {
                    // Enviar texto
                    response = await API.post('/api/send-whatsapp', {
                        phone: fullPhone,
                        message: message
                    }, token);
                }

                data = await response.json();
                console.log('[DEBUG] Response data:', data);

                if (data.success) {
                    const successMsg = hasAudio ? '√Åudio enviado com sucesso! ‚úì' : 'Mensagem enviada com sucesso! ‚úì';
                    showMessage('send-message', successMsg, 'success');
                    document.getElementById('sendForm').reset();
                    removeAudio(); // Limpar √°udio se houver
                    updateCreditsDisplay(data.whatsapp_credits, data.sms_credits);
                    loadHistory();
                } else {
                    if (data.moderationReason) {
                        showMessage('send-message', '‚ö†Ô∏è Mensagem bloqueada: Sua mensagem cont√©m conte√∫do inadequado e n√£o pode ser enviada. Por favor, revise o texto e tente novamente.', 'error');
                    } else {
                        showMessage('send-message', data.error, 'error');
                    }
                }
            } catch (error) {
                console.error('[DEBUG] Erro completo:', error);
                showMessage('send-message', 'Erro: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Enviar Mensagem';
            }
        }


        function selectQuantity(qty) {
            selectedQuantity = qty;
            document.querySelectorAll('.quantity-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.target.closest('.quantity-option').classList.add('selected');
            document.getElementById('custom-quantity').value = qty;
        }

        async function buyCredits() {
            const quantity = parseInt(document.getElementById('custom-quantity').value) || selectedQuantity;

            if (!quantity || quantity < 1) {
                showMessage('buy-message', 'Por favor, selecione ou digite uma quantidade', 'error');
                return;
            }

            const btn = document.getElementById('buy-btn');
            btn.disabled = true;
            btn.textContent = 'Criando pagamento...';

            try {
                const response = await API.post('/api/create-payment', {
                    quantity: quantity,
                    creditType: 'whatsapp'
                }, token);

                const data = await response.json();

                if (data.success) {
                    window.location.href = data.checkoutUrl;
                } else {
                    showMessage('buy-message', data.error, 'error');
                    btn.disabled = false;
                    btn.textContent = 'Comprar Mensagens';
                }
            } catch (error) {
                showMessage('buy-message', 'Erro: ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = 'Comprar Mensagens';
            }
        }


        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            token = null;
            user = null;
            disconnectSocket(); 
            stopRepliesPolling();
            updateUI();
        }

        function connectSocket() {
            if (socket) return; 

            socket = io(API_CONFIG.baseURL, {
                transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                if (user && user.id) {
                    socket.emit('authenticate', user.id);
                }
            });

            socket.on('disconnect', () => {});

            socket.on('new-reply', (reply) => {
                loadReplies();
  
                loadHistory();
                showNewReplyNotification(reply);
            });
        }

        function disconnectSocket() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
        }

        function showNewReplyNotification(reply) {
            const hasAudio = reply.audio_url && reply.audio_url.length > 0;
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
                color: white;
                padding: 15px 20px;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(79, 70, 229, 0.4);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                max-width: 350px;
            `;
            const icon = hasAudio ? 'üé§' : 'üì±';
            const title = hasAudio ? 'Nova Resposta de √Åudio!' : 'Nova Resposta!';
            notification.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 5px;">${icon} ${title}</div>
                <div style="font-size: 14px; opacity: 0.95;">${reply.message.substring(0, 100)}${reply.message.length > 100 ? '...' : ''}</div>
            `;

 
            if (!document.getElementById('notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(notification);


            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in forwards';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }


        function startRepliesPolling() {
            if (repliesPollingInterval) return; 


            repliesPollingInterval = setInterval(() => {
                if (token) {
                    loadReplies();
                    loadHistory();
                }
            }, 60000);
        }

        function stopRepliesPolling() {
            if (repliesPollingInterval) {
                clearInterval(repliesPollingInterval);
                repliesPollingInterval = null;
            }
        }


        function showMessage(elementId, text, type) {
            const message = document.getElementById(elementId);
            message.innerHTML = text;
            message.className = `message ${type}`;
            message.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => {
                    message.style.display = 'none';
                }, 5000);
            }
        }

        function showModalMessage(text, type) {
            const message = document.getElementById('modal-message');
            message.textContent = text;
            message.className = `message ${type}`;
            message.style.display = 'block';
        }

        window.onclick = function(event) {
            const forgotModal = document.getElementById('forgotPasswordModal');

            if (event.target == forgotModal) {
                closeForgotPasswordModal();
            }
        }

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('payment') === 'success' && token) {
            setTimeout(() => {
                loadUserData();
                showMessage('buy-message', 'Mensagens adicionadas com sucesso!', 'success');
            }, 1000);
        }

        updateUI();
    </script>

    <!-- Se√ß√£o de Suporte -->
    <div style="max-width: 700px; margin: 30px auto 20px; padding: 0 20px;">
        <div style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 12px; padding: 25px; text-align: center; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);">
            <h3 style="color: white; font-size: 18px; margin-bottom: 10px; font-weight: 600;">
                ü¶∏‚Äç‚ôÇÔ∏è Suporte 24 Horas (Sim, a gente nao dorme!)
            </h3>
            <p style="color: #94a3b8; font-size: 14px; line-height: 1.6; margin-bottom: 15px;">
                Ficou com duvida? Nossa equipe ta sempre de plantao<br>- tipo aquele amigo que responde de madrugada! ‚òï
            </p>
            <a href="mailto:zapanonimo2025@gmail.com" style="display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="white">
                    <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                </svg>
                zapanonimo2025@gmail.com
            </a>
        </div>
    </div>
</body>
</html>
