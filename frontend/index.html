<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zap Anônimo - Envie Mensagens pelo WhatsApp</title>
    <style>
        /* Variáveis de Tema */
        :root {
            --bg-body: linear-gradient(to bottom, #f0f4f8 0%, #ffffff 100%);
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f0f4f8;
            --bg-input: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --border-light: #ddd;
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            --card-shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.08);
            --modal-overlay: rgba(0, 0, 0, 0.5);
        }

        html.dark-mode {
            --bg-body: linear-gradient(to bottom, #0f172a 0%, #1e293b 100%);
            --bg-primary: #1e293b;
            --bg-secondary: #334155;
            --bg-tertiary: #0f172a;
            --bg-input: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #334155;
            --border-light: #475569;
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            --card-shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.4);
            --modal-overlay: rgba(0, 0, 0, 0.7);
        }

        /* Dark mode overrides para elementos com estilos inline */
        html.dark-mode h3[style*="color: #374151"] {
            color: var(--text-primary) !important;
        }

        html.dark-mode div[style*="border-top: 1px solid #e5e7eb"] {
            border-top-color: var(--border-color) !important;
        }

        html.dark-mode h2[style*="color: #1e293b"] {
            color: var(--text-primary) !important;
        }

        /* Phone prefix (+55) styling */
        .phone-prefix {
            width: 60px;
            background: var(--bg-secondary) !important;
            color: var(--text-secondary) !important;
            border: 2px solid var(--border-color) !important;
        }

        /* Override inline styles for +55 inputs */
        html.dark-mode input[value="+55"][readonly] {
            background: var(--bg-secondary) !important;
            color: var(--text-secondary) !important;
        }

        /* Override para seção "Como funciona" */
        html.dark-mode div[style*="background: #ffffff"] {
            background: var(--bg-primary) !important;
            border-color: var(--border-color) !important;
        }

        html.dark-mode h3[style*="color: #1e293b"] {
            color: var(--text-primary) !important;
        }

        html.dark-mode p[style*="color: #64748b"] {
            color: var(--text-secondary) !important;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-body);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }

        .navbar {
            max-width: 700px;
            margin: 0 auto 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-primary);
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 15px;
                flex-direction: column;
                gap: 15px;
            }
        }

        .navbar h1 {
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .whatsapp-icon {
            width: 32px;
            height: 32px;
            background: #25D366;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .whatsapp-icon svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        @media (max-width: 768px) {
            .navbar h1 {
                font-size: 20px;
            }
        }

        .navbar-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .navbar-buttons {
                width: 100%;
                flex-direction: column;
                gap: 8px;
            }
        }

        .user-email {
            color: var(--text-primary);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .user-email {
                max-width: 100%;
                width: 100%;
                text-align: center;
                font-size: 13px;
                order: 3;
                background: var(--bg-secondary);
                padding: 8px;
                border-radius: 6px;
            }

            .credits-badge {
                order: 1;
                flex: 1;
                text-align: center;
            }

            .btn-nav {
                order: 2;
                flex: 1;
                width: 100%;
            }
        }

        .btn-nav {
            padding: 10px 24px;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-nav:hover {
            background: #4338ca;
            transform: translateY(-1px);
        }

        /* Botão Dark Mode */
        .btn-theme-toggle {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-theme-toggle:hover {
            background: var(--bg-tertiary);
            transform: translateY(-1px);
        }

        /* Dropdown de Notificações */
        .notification-dropdown {
            position: relative;
            display: inline-block;
            margin-right: 10px;
        }

        .notification-btn {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }

        .notification-btn:hover {
            border-color: #4f46e5;
            background: #eef2ff;
        }

        .notification-btn svg {
            color: #64748b;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            font-size: 11px;
            font-weight: 700;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
        }

        .notification-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: calc(100% + 8px);
            background: var(--bg-primary);
            width: 360px;
            max-height: 450px;
            border-radius: 12px;
            box-shadow: var(--card-shadow-lg);
            z-index: 1000;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .notification-dropdown.active .notification-dropdown-content {
            display: block;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .notification-header strong {
            font-size: 16px;
            color: var(--text-primary);
        }

        .mark-all-read-btn {
            background: none;
            border: none;
            color: #4f46e5;
            font-size: 12px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
        }

        .mark-all-read-btn:hover {
            background: var(--bg-secondary);
        }

        .notification-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .notification-empty {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-muted);
        }

        .notification-item {
            display: flex;
            gap: 12px;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }

        .notification-item:hover {
            background: var(--bg-secondary);
        }

        .notification-item.unread {
            background: rgba(239, 68, 68, 0.1);
        }

        .notification-item.unread:hover {
            background: rgba(239, 68, 68, 0.15);
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 18px;
        }

        .notification-icon.blocked {
            background: #fee2e2;
        }

        .notification-icon.unblocked {
            background: #dcfce7;
        }

        .notification-body {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
            margin-bottom: 4px;
        }

        .notification-message {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .notification-time {
            color: var(--text-muted);
            font-size: 11px;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .notification-dropdown-content {
                position: fixed;
                left: 10px;
                right: 10px;
                width: auto;
                top: 70px;
            }
        }

        /* Dropdown Menu - Minha Conta */
        .user-dropdown {
            position: relative;
            display: inline-block;
        }

        .user-dropdown-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .user-dropdown-btn:hover {
            border-color: #4f46e5;
            background: var(--bg-tertiary);
        }

        .user-dropdown-btn svg {
            width: 16px;
            height: 16px;
            transition: transform 0.3s;
        }

        .user-dropdown.active .user-dropdown-btn svg {
            transform: rotate(180deg);
        }

        .user-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: calc(100% + 8px);
            background: var(--bg-primary);
            min-width: 220px;
            border-radius: 12px;
            box-shadow: var(--card-shadow-lg);
            z-index: 1000;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .user-dropdown.active .user-dropdown-content {
            display: block;
            animation: dropdownFade 0.2s ease;
        }

        @keyframes dropdownFade {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-dropdown-header {
            padding: 15px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .user-dropdown-header strong {
            display: block;
            color: var(--text-primary);
            font-size: 14px;
            margin-bottom: 2px;
        }

        .user-dropdown-header span {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .user-dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .user-dropdown-item:hover {
            background: var(--bg-secondary);
        }

        .user-dropdown-item svg {
            width: 18px;
            height: 18px;
            color: var(--text-secondary);
        }

        .user-dropdown-item.danger {
            color: #dc2626;
        }

        .user-dropdown-item.danger:hover {
            background: rgba(220, 38, 38, 0.1);
        }

        .user-dropdown-divider {
            height: 1px;
            background: var(--border-color);
            margin: 5px 0;
        }

        @media (max-width: 768px) {
            .user-dropdown {
                width: 100%;
            }

            .user-dropdown-btn {
                width: 100%;
                justify-content: center;
            }

            .user-dropdown-content {
                left: 0;
                right: 0;
                min-width: 100%;
            }
        }

        .credits-badge {
            background: var(--bg-secondary);
            color: #4f46e5;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600;
        }

        html.dark-mode .credits-badge {
            color: #818cf8;
        }

        .channel-btn {
            flex: 1;
            padding: 12px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .channel-btn:hover {
            border-color: #4f46e5;
        }

        .channel-btn.active {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--bg-primary);
            padding: 30px;
            border-radius: 10px;
            box-shadow: var(--card-shadow-lg);
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        h2 {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 20px;
        }

        .subtitle {
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .password-wrapper {
            position: relative;
        }

        .toggle-password {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            width: 20px;
            height: 20px;
            user-select: none;
            color: var(--text-secondary);
            transition: color 0.3s;
        }

        .toggle-password:hover {
            color: #25D366;
        }

        .toggle-password svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: bold;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-light);
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s, background 0.3s;
            background: var(--bg-input);
            color: var(--text-primary);
        }

        input[type="password"],
        input.password-input {
            padding-right: 45px;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #25D366;
        }

        textarea {
            resize: vertical;
            min-height: 180px;
            font-family: Arial, sans-serif;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background-color: #4f46e5;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            background-color: #4338ca;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .btn:disabled {
            background-color: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-size: 17px;
            padding: 18px;
            font-weight: 700;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #5568d3 0%, #5e3a7f 100%);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 5px;
            text-align: center;
            display: none;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hint {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .info-box {
            background: var(--bg-secondary);
            border-left: 4px solid #4f46e5;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .info-box p {
            margin: 5px 0;
            color: var(--text-primary);
            font-size: 14px;
        }

        .info-box strong {
            color: #4f46e5;
        }

        html.dark-mode .info-box strong {
            color: #818cf8;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 20px 0;
        }

        .modal-content {
            background-color: var(--bg-primary);
            margin: 0 auto;
            padding: 40px;
            border-radius: 10px;
            width: 90%;
            max-width: 450px;
            max-height: none;
            box-shadow: var(--card-shadow-lg);
            transition: background 0.3s ease;
        }

        @media (max-width: 768px) {
            .modal {
                padding: 10px 0;
            }
            .modal-content {
                padding: 25px 20px;
                width: 95%;
            }
        }

        .close {
            color: var(--text-muted);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--text-primary);
        }

        /* Banner de Anúncio */
        .announcement-banner {
            grid-column: 1 / -1;
            max-width: 100%;
            margin: 0 0 20px 0;
            border-radius: 12px;
            overflow: hidden;
        }

        .announcement-banner.maintenance {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 1px solid #fca5a5;
        }

        .announcement-banner.warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #fcd34d;
        }

        .announcement-banner.announcement {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 1px solid #93c5fd;
        }

        .announcement-banner-content {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
        }

        .announcement-banner-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .announcement-banner-text {
            flex: 1;
        }

        .announcement-banner-text strong {
            display: block;
            color: #1e293b;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .announcement-banner-text span {
            color: #475569;
            font-size: 13px;
        }

        .announcement-banner-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #64748b;
            cursor: pointer;
            padding: 0 5px;
        }

        .announcement-banner-close:hover {
            color: #1e293b;
        }

        /* Modal de Anúncio */
        .announcement-modal {
            text-align: center;
        }

        .announcement-modal-header {
            margin-bottom: 20px;
        }

        .announcement-modal-header.maintenance {
            color: #dc2626;
        }

        .announcement-modal-header.warning {
            color: #d97706;
        }

        .announcement-modal-header.announcement {
            color: #2563eb;
        }

        .announcement-modal-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .announcement-modal-header h2 {
            font-size: 22px;
            margin: 0;
        }

        .announcement-modal-body p {
            color: #475569;
            line-height: 1.6;
            margin: 0;
            white-space: pre-wrap;
        }

        .announcement-modal-date {
            margin-top: 15px !important;
            font-size: 12px;
            color: #94a3b8 !important;
        }

        @media (max-width: 768px) {
            .announcement-banner-content {
                padding: 12px 15px;
            }

            .announcement-banner-text strong {
                font-size: 13px;
            }

            .announcement-banner-text span {
                font-size: 12px;
            }
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            color: #666;
            font-weight: bold;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }

        .form-content {
            display: none;
        }

        .form-content.active {
            display: block;
        }

        .quantity-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .quantity-selector {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .quantity-option {
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--bg-primary);
        }

        .quantity-option:hover {
            border-color: #4f46e5;
        }

        .quantity-option.selected {
            border-color: #4f46e5;
            background-color: var(--bg-secondary);
        }

        html.dark-mode .quantity-option.selected {
            background-color: rgba(79, 70, 229, 0.2);
        }

        .quantity-option .amount {
            font-size: 18px;
            font-weight: bold;
            color: #4f46e5;
            line-height: 1.3;
        }

        html.dark-mode .quantity-option .amount {
            color: #818cf8;
        }

        .quantity-option .price {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item .date {
            font-size: 12px;
            color: var(--text-muted);
        }

        .history-item .details {
            margin-top: 5px;
            color: var(--text-primary);
        }

        .history-item.reply-item {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 4px solid #4f46e5;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        html.dark-mode .history-item.reply-item {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.15) 0%, rgba(99, 102, 241, 0.1) 100%);
        }

        .welcome-message {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        .welcome-message h2 {
            color: white;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .welcome-message p {
            font-size: 16px;
            opacity: 0.9;
        }

        .hidden {
            display: none !important;
        }

        /* Estilos para controles de áudio */
        .audio-controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .audio-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-audio {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 52px;
            height: 52px;
            padding: 0;
            background: #25D366;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(37, 211, 102, 0.3);
        }

        .btn-audio svg {
            width: 24px;
            height: 24px;
            fill: #000;
        }

        .btn-audio:hover {
            background: #20bd5a;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
        }

        .btn-audio.recording {
            background: #ef4444;
            animation: pulse-recording 1.5s infinite;
        }

        .btn-audio.recording svg {
            fill: #fff;
        }

        @keyframes pulse-recording {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }

        .btn-upload {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-color: #86efac;
            color: #166534;
        }

        .btn-upload:hover {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-color: #4ade80;
        }

        .audio-preview {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #7dd3fc;
            border-radius: 10px;
        }

        .audio-preview audio {
            flex: 1;
            height: 40px;
        }

        .btn-remove-audio {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #ef4444;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-remove-audio:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .recording-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 2px solid #fca5a5;
            border-radius: 10px;
            color: #dc2626;
            font-weight: 600;
        }

        .recording-dot {
            width: 12px;
            height: 12px;
            background: #ef4444;
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Player de áudio nas respostas */
        .reply-audio-player {
            margin-top: 10px;
            padding: 10px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 8px;
        }

        .reply-audio-player audio {
            width: 100%;
            height: 36px;
        }

        .audio-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: #dbeafe;
            color: #1d4ed8;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Estilos para emoji picker */
        .message-input-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message-input-container textarea {
            width: 100%;
        }

        .emoji-toggle-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .emoji-toggle-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-light);
        }

        .emoji-toggle-btn .emoji-icon {
            font-size: 18px;
        }

        .emoji-bar {
            display: none;
            flex-wrap: wrap;
            gap: 4px;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-top: 8px;
        }

        .emoji-bar.show {
            display: flex;
        }

        .emoji-bar span {
            font-size: 22px;
            padding: 6px 8px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.15s ease;
        }

        .emoji-bar span:hover {
            background: var(--bg-tertiary);
            transform: scale(1.2);
        }

        @media (max-width: 768px) {
            .emoji-bar span {
                font-size: 20px;
                padding: 5px 6px;
            }
        }

        /* Melhorias Mobile */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .card {
                padding: 20px 15px;
                border-radius: 12px;
            }

            h2 {
                font-size: 18px;
            }

            .subtitle {
                font-size: 13px;
            }

            label {
                font-size: 13px;
            }

            input, textarea {
                font-size: 16px;
                padding: 14px 12px;
            }

            textarea {
                min-height: 150px;
            }

            .btn {
                padding: 14px;
                font-size: 15px;
            }

            .btn-audio {
                width: 48px;
                height: 48px;
            }

            .btn-audio svg {
                width: 22px;
                height: 22px;
            }

            .emoji-toggle-btn {
                padding: 10px 16px;
                font-size: 14px;
            }

            .form-group {
                margin-bottom: 16px;
            }

            .hint {
                font-size: 11px;
            }

            .audio-controls {
                gap: 10px;
            }

            .recording-indicator {
                padding: 10px 12px;
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 8px;
            }

            .navbar {
                padding: 12px;
                margin-bottom: 15px;
            }

            .navbar h1 {
                font-size: 18px;
            }

            .card {
                padding: 16px 12px;
            }

            h2 {
                font-size: 16px;
            }

            .quantity-selector {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .quantity-option {
                padding: 12px 8px;
            }

            .quantity-option .quantity {
                font-size: 18px;
            }

            .btn-small {
                padding: 10px 16px;
                font-size: 13px;
            }
        }

        /* Favoritos */
        .favorites-container {
            margin-top: 10px;
        }

        .favorites-row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn-favorites {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #f59e0b;
            border-radius: 20px;
            font-size: 13px;
            color: #92400e;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-favorites:hover {
            background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%);
            transform: scale(1.02);
        }

        .favorites-select {
            flex: 1;
            min-width: 150px;
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-input);
            color: var(--text-primary);
            cursor: pointer;
        }

        .favorites-select:focus {
            outline: none;
            border-color: #f59e0b;
        }

        /* Modal Favoritos */
        .favorites-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .favorites-modal.show {
            display: flex;
        }

        .favorites-modal-content {
            background: var(--bg-primary);
            border-radius: 16px;
            width: 100%;
            max-width: 450px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .favorites-modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .favorites-modal-header h3 {
            margin: 0;
            font-size: 18px;
            color: var(--text-primary);
        }

        .favorites-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            line-height: 1;
        }

        .favorites-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .favorites-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .favorite-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .favorite-item-info {
            flex: 1;
        }

        .favorite-item-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .favorite-item-phone {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .favorite-item-actions {
            display: flex;
            gap: 6px;
        }

        .favorite-item-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .favorite-item-btn.use {
            background: #25D366;
            color: white;
        }

        .favorite-item-btn.delete {
            background: #ef4444;
            color: white;
        }

        .favorite-item-btn:hover {
            opacity: 0.9;
            transform: scale(1.05);
        }

        .favorites-empty {
            text-align: center;
            padding: 30px;
            color: #64748b;
        }

        .favorites-add-form {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .favorites-add-form h4 {
            margin: 0 0 15px 0;
            font-size: 14px;
            color: #1e293b;
        }

        .favorites-add-form input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .favorites-add-form input:focus {
            outline: none;
            border-color: #f59e0b;
        }

        .favorites-add-form button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .favorites-add-form button:hover {
            opacity: 0.9;
        }

        /* Prompt salvar favorito */
        .save-favorite-prompt {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-primary);
            padding: 20px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 30px rgba(0,0,0,0.2);
            z-index: 9999;
            max-width: 350px;
            width: calc(100% - 40px);
        }

        .save-favorite-prompt.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { transform: translate(-50%, -50%) scale(0.9); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .save-favorite-prompt p {
            margin: 0 0 12px 0;
            font-size: 14px;
            color: var(--text-primary);
        }

        .save-favorite-prompt-buttons {
            display: flex;
            gap: 10px;
        }

        .save-favorite-prompt-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .save-favorite-prompt-buttons .btn-save {
            background: #f59e0b;
            color: white;
        }

        .save-favorite-prompt-buttons .btn-skip {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        /* Modal de Confirmacao/Alerta Personalizado */
        .custom-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99999;
            justify-content: center;
            align-items: center;
        }

        .custom-modal-overlay.show {
            display: flex;
            animation: fadeInOverlay 0.2s ease;
        }

        @keyframes fadeInOverlay {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .custom-modal-box {
            background: var(--bg-primary);
            padding: 28px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
            max-width: 380px;
            width: calc(100% - 40px);
            text-align: center;
            animation: scaleIn 0.2s ease;
        }

        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .custom-modal-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .custom-modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .custom-modal-message {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .custom-modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .custom-modal-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .custom-modal-btn:hover {
            transform: translateY(-1px);
        }

        .custom-modal-btn.primary {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
        }

        .custom-modal-btn.primary:hover {
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .custom-modal-btn.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .custom-modal-btn.danger:hover {
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .custom-modal-btn.secondary {
            background: #f1f5f9;
            color: #64748b;
        }

        .custom-modal-btn.secondary:hover {
            background: #e2e8f0;
        }

        .custom-modal-btn.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .custom-modal-btn.success:hover {
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        /* Modal PIX */
        .pix-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 99999;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .pix-modal.show {
            display: flex;
        }

        .pix-modal-content {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .pix-modal-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .pix-modal-subtitle {
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-size: 14px;
        }

        .pix-qr-container {
            background: #ffffff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .pix-qr-container img {
            max-width: 200px;
            border-radius: 8px;
        }

        .pix-code-container {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            word-break: break-all;
            font-family: monospace;
            font-size: 11px;
            color: var(--text-secondary);
            max-height: 80px;
            overflow-y: auto;
        }

        .pix-copy-btn {
            background: linear-gradient(135deg, #00b4ab 0%, #00968f 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .pix-copy-btn:hover {
            opacity: 0.9;
        }

        .pix-status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 14px;
        }

        .pix-status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .pix-status.approved {
            background: #d1fae5;
            color: #065f46;
        }

        .pix-close-btn {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .favorites-row {
                flex-direction: column;
                align-items: stretch;
            }

            .favorites-select {
                width: 100%;
            }

            .favorites-modal-content {
                max-height: 90vh;
            }

            .favorite-item {
                flex-wrap: wrap;
            }

            .favorite-item-actions {
                width: 100%;
                margin-top: 8px;
            }

            .favorite-item-btn {
                flex: 1;
            }
        }

        /* Footer Styles */
        .site-footer {
            max-width: 700px;
            margin: 40px auto 20px;
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-size: 14px;
        }

        .footer-social {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .social-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            text-decoration: none;
            font-size: 14px;
        }

        .social-link svg {
            width: 18px;
            height: 18px;
        }

        .social-link.instagram {
            color: #E4405F;
        }

        .social-link.instagram svg {
            fill: #E4405F;
        }

        .social-link.tiktok {
            color: #000000;
        }

        .social-link.tiktok svg {
            fill: #000000;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px 20px;
            margin-bottom: 15px;
        }

        .footer-links a {
            color: #4f46e5;
            text-decoration: none;
            font-size: 14px;
        }

        .footer-links a:hover {
            text-decoration: underline;
        }

        .footer-copyright {
            margin: 0;
            color: #94a3b8;
            font-size: 12px;
            line-height: 1.5;
        }

        @media (max-width: 480px) {
            .site-footer {
                padding: 15px 10px;
            }

            .footer-social {
                gap: 15px;
            }

            .social-link {
                font-size: 13px;
            }

            .social-link svg {
                width: 16px;
                height: 16px;
            }

            .footer-links {
                gap: 8px 15px;
            }

            .footer-links a {
                font-size: 13px;
            }

            .footer-copyright {
                font-size: 11px;
            }
        }

        /* LGPD / Minha Conta Buttons */
        .lgpd-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        @media (max-width: 480px) {
            .lgpd-buttons {
                grid-template-columns: 1fr;
            }
        }

        .lgpd-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .lgpd-btn:hover {
            border-color: #4f46e5;
            background: #eef2ff;
            transform: translateY(-2px);
        }

        .lgpd-btn-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .lgpd-btn-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .lgpd-btn-text strong {
            color: #1e293b;
            font-size: 14px;
        }

        .lgpd-btn-text span {
            color: #64748b;
            font-size: 12px;
        }

        .lgpd-btn-danger {
            background: #fef2f2;
            border-color: #fecaca;
        }

        .lgpd-btn-danger:hover {
            border-color: #dc2626;
            background: #fee2e2;
        }

        .lgpd-btn-danger .lgpd-btn-text strong {
            color: #dc2626;
        }

        /* LGPD Data Display */
        .lgpd-data-section {
            margin-bottom: 20px;
        }

        .lgpd-data-section h4 {
            color: #1e293b;
            font-size: 14px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e2e8f0;
        }

        .lgpd-data-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .lgpd-data-item:last-child {
            border-bottom: none;
        }

        .lgpd-data-label {
            color: #64748b;
            font-size: 13px;
        }

        .lgpd-data-value {
            color: #1e293b;
            font-size: 13px;
            font-weight: 500;
        }

        .delete-warning {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .delete-warning p {
            color: #991b1b;
            font-size: 14px;
            margin: 0;
        }

        .delete-warning ul {
            color: #991b1b;
            font-size: 13px;
            margin: 10px 0 0 20px;
        }

        /* Toast Notification */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            min-width: 300px;
            max-width: 450px;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: toastSlideIn 0.3s ease-out;
            font-size: 14px;
            font-weight: 500;
        }

        .toast.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .toast.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .toast.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .toast.info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .toast-message {
            flex: 1;
            line-height: 1.4;
        }

        .toast-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
            transition: background 0.2s;
        }

        .toast-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        @keyframes toastSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes toastSlideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @media (max-width: 480px) {
            .toast-container {
                left: 10px;
                right: 10px;
                top: 10px;
            }
            .toast {
                min-width: auto;
                width: 100%;
            }
        }

        /* Confirm Modal */
        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            animation: fadeIn 0.2s ease-out;
        }

        .confirm-modal.show {
            display: flex;
        }

        .confirm-modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        .confirm-modal-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 30px;
        }

        .confirm-modal-icon.warning {
            background: #fef3c7;
            color: #d97706;
        }

        .confirm-modal-icon.danger {
            background: #fee2e2;
            color: #dc2626;
        }

        .confirm-modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 10px;
        }

        .confirm-modal-message {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .confirm-modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .confirm-modal-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .confirm-modal-btn.cancel {
            background: #f1f5f9;
            color: #64748b;
        }

        .confirm-modal-btn.cancel:hover {
            background: #e2e8f0;
        }

        .confirm-modal-btn.confirm {
            background: #dc2626;
            color: white;
        }

        .confirm-modal-btn.confirm:hover {
            background: #b91c1c;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-modal-content">
            <div id="confirmModalIcon" class="confirm-modal-icon danger">⚠</div>
            <h3 id="confirmModalTitle" class="confirm-modal-title">Confirmar ação</h3>
            <p id="confirmModalMessage" class="confirm-modal-message">Tem certeza que deseja continuar?</p>
            <div class="confirm-modal-buttons">
                <button id="confirmModalCancel" class="confirm-modal-btn cancel">Cancelar</button>
                <button id="confirmModalConfirm" class="confirm-modal-btn confirm">Confirmar</button>
            </div>
        </div>
    </div>

    <div class="navbar">
        <h1>
            <div class="whatsapp-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                </svg>
            </div>
            Zap Anônimo
        </h1>
        <div class="navbar-buttons" id="navbar-buttons">
            <button class="btn-theme-toggle" onclick="toggleDarkMode()" title="Alternar tema">
                <span id="theme-icon">🌙</span>
            </button>
            <button class="btn-nav" onclick="openLoginModal()">Entrar / Cadastrar</button>
        </div>
    </div>


    <div class="main-container" id="welcome-section">
        <div class="card full-width" style="text-align: center; max-width: 700px; margin: 0 auto;">

            <div style="margin-bottom: 40px;">
                <h2 style="font-size: 42px; color: #1e293b; font-weight: 700; margin-bottom: 15px; line-height: 1.2;">
                    Mensagens Anônimas<br>no WhatsApp
                </h2>
                <p style="font-size: 20px; color: #64748b; font-weight: 400; margin-top: 15px;">
                    Envie mensagens sem revelar sua identidade ao destinatário
                </p>
            </div>

            <div style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); padding: 40px; border-radius: 16px; margin: 40px 0; color: white; box-shadow: 0 10px 40px rgba(79, 70, 229, 0.2);">

                <div style="text-align: center; margin-bottom: 25px;">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">📱 WhatsApp</div>
                    <div style="font-size: 48px; font-weight: 700;">R$ 1,00</div>
                    <div style="font-size: 16px; opacity: 0.85;">por mensagem</div>
                    <div style="font-size: 12px; opacity: 0.75; margin-top: 10px;">Sem assinatura • Pague apenas pelo que usar • Cancele quando quiser</div>
                </div>


                <div style="background: rgba(255, 255, 255, 0.15); padding: 20px; border-radius: 12px; backdrop-filter: blur(10px);">
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 15px; opacity: 0.95;">🔥 GANHE EM DOBRO! 🔥</div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 14px;">
                        <div style="text-align: left;">
                            <strong>Pague 5</strong>
                            <div style="font-size: 13px; opacity: 0.9; margin-top: 3px;">Receba <span style="color: #4ade80; font-weight: 600;">10 msgs</span></div>
                        </div>
                        <div style="text-align: left;">
                            <strong>Pague 25</strong>
                            <div style="font-size: 13px; opacity: 0.9; margin-top: 3px;">Receba <span style="color: #4ade80; font-weight: 600;">50 msgs</span></div>
                        </div>
                        <div style="text-align: left;">
                            <strong>Pague 50</strong>
                            <div style="font-size: 13px; opacity: 0.9; margin-top: 3px;">Receba <span style="color: #4ade80; font-weight: 600;">100 msgs</span></div>
                        </div>
                        <div style="text-align: left;">
                            <strong>Pague 100</strong>
                            <div style="font-size: 13px; opacity: 0.9; margin-top: 3px;">Receba <span style="color: #4ade80; font-weight: 600;">200 msgs</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="text-align: left; margin: 40px 0; background: #ffffff; border: 1px solid #e2e8f0; padding: 30px; border-radius: 12px;">
                <div style="display: flex; align-items: start; gap: 15px; margin-bottom: 20px;">
                    <div style="background: #4f46e5; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 18px; font-weight: 600;">1</div>
                    <div>
                        <h3 style="color: #1e293b; font-size: 16px; margin-bottom: 5px; font-weight: 600;">Informe o destinatário</h3>
                        <p style="color: #64748b; font-size: 14px; margin: 0;">Digite o número de WhatsApp para quem deseja enviar</p>
                    </div>
                </div>
                <div style="display: flex; align-items: start; gap: 15px; margin-bottom: 20px;">
                    <div style="background: #4f46e5; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 18px; font-weight: 600;">2</div>
                    <div>
                        <h3 style="color: #1e293b; font-size: 16px; margin-bottom: 5px; font-weight: 600;">Escreva sua mensagem</h3>
                        <p style="color: #64748b; font-size: 14px; margin: 0;">Crie o texto que será enviado de forma anônima</p>
                    </div>
                </div>
                <div style="display: flex; align-items: start; gap: 15px;">
                    <div style="background: #4f46e5; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 18px; font-weight: 600;">3</div>
                    <div>
                        <h3 style="color: #1e293b; font-size: 16px; margin-bottom: 5px; font-weight: 600;">Envie com segurança</h3>
                        <p style="color: #64748b; font-size: 14px; margin: 0;">Sua mensagem é entregue instantaneamente, sem revelar o remetente ao destinatário</p>
                    </div>
                </div>
            </div>

            <button class="btn" onclick="openLoginModal()" style="font-size: 18px; padding: 18px; margin-top: 20px;">
                Começar Agora
            </button>
            <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; color: white;">
                <p style="font-size: 18px; font-weight: 600; margin: 0 0 10px 0;">
                    🎁 Bônus de Boas-Vindas
                </p>
                <p style="font-size: 15px; margin: 0; opacity: 0.95;">
                    Crie sua conta e receba <strong>5 mensagens gratuitas</strong> para testar a plataforma.
                </p>
            </div>
        </div>
    </div>


    <div class="main-container hidden" id="main-section">

        <!-- Banner de Anúncio/Manutenção -->
        <div id="announcementBanner" class="announcement-banner" style="display: none;">
            <div class="announcement-banner-content">
                <div class="announcement-banner-icon" id="announcementBannerIcon"></div>
                <div class="announcement-banner-text">
                    <strong id="announcementBannerTitle"></strong>
                    <span id="announcementBannerMessage"></span>
                </div>
                <button class="announcement-banner-close" onclick="closeAnnouncementBanner()">&times;</button>
            </div>
        </div>

        <div class="card">
            <h2>Enviar Mensagem</h2>
            <p class="subtitle">Envie mensagens de forma anônima e instantânea</p>

            <div class="info-box">
                <p><strong>Custo:</strong> R$ 1,00 por mensagem</p>
                <p><strong>Saldo:</strong> 📱 <span id="credits-send-whatsapp">0</span> mensagens</p>
            </div>

            <form id="sendForm" onsubmit="handleSend(event)">
                <div class="form-group">
                    <label for="phone">Número de Telefone</label>
                    <div style="display: flex; gap: 10px;">
                        <input
                            type="text"
                            value="+55"
                            readonly
                            class="phone-prefix"
                        >
                        <input
                            type="tel"
                            id="phone"
                            placeholder="11999999999"
                            required
                            pattern="[0-9]{10,11}"
                            maxlength="11"
                            style="flex: 1;"
                        >
                    </div>
                    <div class="favorites-container">
                        <div class="favorites-row">
                            <select id="favorites-select" class="favorites-select" onchange="selectFavorite(this.value)">
                                <option value="">Selecionar favorito...</option>
                            </select>
                            <button type="button" class="btn-favorites" onclick="openFavoritesModal()">
                                <span>⭐</span>
                                <span>Gerenciar</span>
                            </button>
                        </div>
                    </div>
                    <p class="hint">Digite apenas DDD + número (ex: 11999999999)</p>
                </div>

                <div class="form-group">
                    <label for="message">Mensagem</label>
                    <div class="message-input-container">
                        <textarea
                            id="message"
                            placeholder="Digite sua mensagem aqui..."
                            maxlength="65536"
                        ></textarea>
                        <button type="button" class="emoji-toggle-btn" onclick="toggleEmojis()">
                            <span class="emoji-icon">😊</span>
                            <span>Emojis</span>
                        </button>
                        <div id="emoji-bar" class="emoji-bar">
                            <span onclick="addEmoji('😀')">😀</span>
                            <span onclick="addEmoji('😂')">😂</span>
                            <span onclick="addEmoji('😍')">😍</span>
                            <span onclick="addEmoji('🥰')">🥰</span>
                            <span onclick="addEmoji('😘')">😘</span>
                            <span onclick="addEmoji('😎')">😎</span>
                            <span onclick="addEmoji('🤔')">🤔</span>
                            <span onclick="addEmoji('😢')">😢</span>
                            <span onclick="addEmoji('😭')">😭</span>
                            <span onclick="addEmoji('😡')">😡</span>
                            <span onclick="addEmoji('👍')">👍</span>
                            <span onclick="addEmoji('👎')">👎</span>
                            <span onclick="addEmoji('👏')">👏</span>
                            <span onclick="addEmoji('🙏')">🙏</span>
                            <span onclick="addEmoji('💪')">💪</span>
                            <span onclick="addEmoji('❤️')">❤️</span>
                            <span onclick="addEmoji('💔')">💔</span>
                            <span onclick="addEmoji('🔥')">🔥</span>
                            <span onclick="addEmoji('✨')">✨</span>
                            <span onclick="addEmoji('🎉')">🎉</span>
                            <span onclick="addEmoji('💯')">💯</span>
                            <span onclick="addEmoji('🤣')">🤣</span>
                            <span onclick="addEmoji('😅')">😅</span>
                            <span onclick="addEmoji('😊')">😊</span>
                            <span onclick="addEmoji('🙄')">🙄</span>
                            <span onclick="addEmoji('😏')">😏</span>
                            <span onclick="addEmoji('😴')">😴</span>
                            <span onclick="addEmoji('🤗')">🤗</span>
                            <span onclick="addEmoji('🤫')">🤫</span>
                            <span onclick="addEmoji('🤭')">🤭</span>
                        </div>
                    </div>
                    <small style="color: #64748b; font-size: 12px;">Máximo: 65.536 caracteres</small>
                </div>

                <!-- Controles de Áudio -->
                <div class="form-group">
                    <label>Ou grave um áudio</label>
                    <div class="audio-controls">
                        <div class="audio-buttons">
                            <button type="button" class="btn-audio" id="record-btn" onclick="toggleRecording()" title="Gravar audio">
                                <svg id="mic-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5z"/>
                                    <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                                </svg>
                                <svg id="stop-icon" style="display:none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="6" y="6" width="12" height="12" rx="2"/>
                                </svg>
                            </button>
                        </div>

                        <!-- Preview do áudio -->
                        <div id="audio-preview-container" class="audio-preview" style="display: none;">
                            <audio id="audio-preview" controls></audio>
                            <button type="button" class="btn-remove-audio" onclick="removeAudio()">✕</button>
                        </div>

                        <!-- Indicador de gravação -->
                        <div id="recording-indicator" class="recording-indicator" style="display: none;">
                            <span class="recording-dot"></span>
                            <span id="recording-time">00:00</span>
                        </div>
                    </div>
                    <small style="color: #64748b; font-size: 12px;">Clique em gravar, fale e clique novamente para parar</small>
                </div>

                <!-- Uso Responsável -->
                <div class="usage-notice" style="display: flex; align-items: center; justify-content: center; gap: 6px; margin: 15px 0 10px 0; font-size: 11px; color: #6b7280;">
                    <span>ℹ️</span>
                    <span>Uso Responsável: mensagens com conteúdo ilegal não são permitidas. <a href="/terms" target="_blank" style="color: #6b7280; text-decoration: underline;">Consulte os Termos de Uso</a></span>
                </div>

                <button type="submit" class="btn" id="send-btn">Enviar Mensagem</button>
            </form>

            <div id="whatsapp-status-indicator" class="message" style="display: none;"></div>
            <div id="send-message" class="message"></div>
        </div>


        <div class="card">
            <h2>Comprar Mensagens</h2>
            <p class="subtitle">R$ 1,00 por mensagem</p>

            <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px; font-weight: 600; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);">
                🔥 PROMOÇÃO: GANHE EM DOBRO! 🔥
            </div>

            <div class="quantity-selector" id="quantity-selector">
                <div class="quantity-option" onclick="selectQuantity(5)">
                    <div class="amount">5 + 5 grátis</div>
                    <div class="price">R$ 5,00 <small style="color: #10b981; font-weight: 600;">= 10 msgs</small></div>
                </div>
                <div class="quantity-option" onclick="selectQuantity(25)">
                    <div class="amount">25 + 25 grátis</div>
                    <div class="price">R$ 25,00 <small style="color: #10b981; font-weight: 600;">= 50 msgs</small></div>
                </div>
                <div class="quantity-option" onclick="selectQuantity(50)">
                    <div class="amount">50 + 50 grátis</div>
                    <div class="price">R$ 50,00 <small style="color: #10b981; font-weight: 600;">= 100 msgs</small></div>
                </div>
                <div class="quantity-option" onclick="selectQuantity(100)">
                    <div class="amount">100 + 100 grátis</div>
                    <div class="price">R$ 100,00 <small style="color: #10b981; font-weight: 600;">= 200 msgs</small></div>
                </div>
            </div>

            <div class="form-group">
                <label for="custom-quantity">Ou digite a quantidade:</label>
                <input
                    type="number"
                    id="custom-quantity"
                    min="1"
                    placeholder="Quantidade de mensagens"
                    oninput="updateBonusPreview()"
                >
                <small id="bonus-preview" style="color: #10b981; font-weight: 600; display: none; margin-top: 8px;"></small>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn" onclick="buyWithPix()" id="buy-pix-btn" style="flex: 1; background: linear-gradient(135deg, #00b4ab 0%, #00968f 100%);">
                    <span style="font-size: 18px;">📱</span> Pagar com PIX
                </button>
                <button class="btn btn-secondary" onclick="buyWithCard()" id="buy-card-btn" style="flex: 1;">
                    <span style="font-size: 18px;">💳</span> Cartão
                </button>
            </div>

            <div id="buy-message" class="message"></div>

            <!-- Histórico de Pagamentos -->
            <div style="margin-top: 25px; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                <h3 style="font-size: 16px; color: #374151; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 18px;">📋</span> Histórico de Pagamentos
                </h3>
                <div id="payment-history" style="max-height: 200px; overflow-y: auto;">
                    <p style="text-align: center; color: #999; font-size: 14px;">Carregando...</p>
                </div>
            </div>
        </div>


        <div class="card">
            <h2>Mensagens Enviadas</h2>
            <p class="subtitle">Histórico de mensagens que você enviou</p>
            <div class="history-list" id="history-list">
                <p style="text-align: center; color: #999;">Carregando...</p>
            </div>
        </div>


        <div class="card">
            <h2>Respostas Recebidas</h2>
            <p class="subtitle">Respostas às suas mensagens anônimas</p>
            <div class="history-list" id="replies-list">
                <p style="text-align: center; color: #999;">Carregando...</p>
            </div>
        </div>
    </div>

    <!-- Modal Acessar Dados -->
    <div id="accessDataModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLgpdModal('accessDataModal')">&times;</span>
            <h2 style="color: #1e293b; margin-bottom: 20px;">Seus Dados</h2>
            <div id="accessDataContent">Carregando...</div>
        </div>
    </div>

    <!-- Modal Alterar Dados -->
    <div id="correctDataModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLgpdModal('correctDataModal')">&times;</span>
            <h2 style="color: #1e293b; margin-bottom: 20px;">Alterar Dados</h2>
            <form id="correctDataForm" onsubmit="submitCorrectData(event)">
                <div class="form-group">
                    <label for="correctName">Nome Completo</label>
                    <input type="text" id="correctName" placeholder="Seu nome completo" minlength="3">
                </div>
                <div class="form-group">
                    <label for="correctCpf">CPF</label>
                    <input type="text" id="correctCpf" placeholder="000.000.000-00" maxlength="14" oninput="maskCPF(this)">
                </div>
                <div class="form-group">
                    <label for="correctEmail">Email</label>
                    <input type="email" id="correctEmail" placeholder="seu@email.com">
                </div>
                <div class="form-group">
                    <label for="correctPhone">Telefone</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" value="+55" readonly class="phone-prefix">
                        <input type="tel" id="correctPhone" placeholder="11999999999" maxlength="11" style="flex: 1;">
                        <button type="button" id="sendPhoneCodeBtn" onclick="sendCorrectPhoneCode()" style="padding: 10px 15px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; white-space: nowrap; display: none;">Verificar</button>
                    </div>
                </div>
                <!-- Campo de verificação do telefone (oculto inicialmente) -->
                <div id="phoneVerificationGroup" class="form-group" style="display: none;">
                    <label for="correctPhoneCode">Código de Verificação</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="correctPhoneCode" placeholder="Digite o código recebido" maxlength="6" style="flex: 1; text-align: center; font-size: 18px; letter-spacing: 5px;">
                        <button type="button" onclick="verifyCorrectPhoneCode()" style="padding: 10px 15px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer;">Confirmar</button>
                    </div>
                    <p style="font-size: 12px; color: #64748b; margin-top: 5px;">Enviamos um código para o WhatsApp informado</p>
                </div>
                <input type="hidden" id="phoneVerified" value="false">
                <button type="submit" class="btn">Salvar Alterações</button>

                <details style="margin-top: 20px;">
                    <summary style="cursor: pointer; color: #64748b; font-size: 14px; padding: 10px 0;">Alterar senha (opcional)</summary>
                    <div style="padding-top: 15px;">
                        <div class="form-group">
                            <label for="correctCurrentPassword">Senha Atual</label>
                            <input type="password" id="correctCurrentPassword" placeholder="Digite sua senha atual">
                        </div>
                        <div class="form-group">
                            <label for="correctNewPassword">Nova Senha</label>
                            <input type="password" id="correctNewPassword" placeholder="Nova senha (mínimo 6 caracteres)">
                        </div>
                    </div>
                </details>
            </form>
            <div id="correctDataMessage" class="message" style="display: none; margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Modal Excluir Conta -->
    <div id="deleteAccountModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLgpdModal('deleteAccountModal')">&times;</span>
            <h2 style="color: #dc2626; margin-bottom: 10px;">Excluir Conta</h2>
            <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <p style="color: #92400e; font-size: 14px; margin: 0 0 10px 0;"><strong>Esta ação é irreversível!</strong></p>
                <ul style="color: #92400e; font-size: 13px; margin: 0; padding-left: 20px;">
                    <li>Suas mensagens e respostas serão removidas</li>
                    <li>Seus créditos serão perdidos</li>
                    <li>Você poderá criar nova conta com o mesmo email/telefone</li>
                </ul>
            </div>
            <form id="deleteAccountForm" onsubmit="submitDeleteAccount(event)">
                <!-- Toggle Email/Telefone -->
                <div id="deleteTypeToggle" class="auth-type-toggle" style="display: none; gap: 10px; margin-bottom: 20px;">
                    <button type="button" id="delete-email-toggle" onclick="toggleDeleteType('email')" style="flex: 1; padding: 10px; border: 2px solid #dc2626; background: #dc2626; color: white; border-radius: 8px; font-weight: 500; cursor: pointer;">
                        Email
                    </button>
                    <button type="button" id="delete-phone-toggle" onclick="toggleDeleteType('phone')" style="flex: 1; padding: 10px; border: 2px solid #e2e8f0; background: white; color: #64748b; border-radius: 8px; font-weight: 500; cursor: pointer;">
                        Telefone
                    </button>
                </div>

                <!-- Campo Email -->
                <div class="form-group" id="delete-email-group">
                    <label>Confirme seu email</label>
                    <input type="email" id="deleteEmailConfirmation" placeholder="seu@email.com">
                    <p id="deleteEmailHint" style="font-size: 12px; color: #64748b; margin-top: 5px;"></p>
                </div>

                <!-- Campo Telefone -->
                <div class="form-group" id="delete-phone-group" style="display: none;">
                    <label>Confirme seu telefone</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" value="+55" readonly class="phone-prefix">
                        <input type="tel" id="deletePhoneConfirmation" placeholder="85991964253" maxlength="11" style="flex: 1;">
                    </div>
                    <p id="deletePhoneHint" style="font-size: 12px; color: #64748b; margin-top: 5px;"></p>
                </div>

                <div class="form-group">
                    <label for="deletePassword">Senha</label>
                    <input type="password" id="deletePassword" required placeholder="Digite sua senha">
                </div>
                <button type="submit" class="btn" style="background: #dc2626;">Excluir Minha Conta</button>
            </form>
            <div id="deleteAccountMessage" class="message" style="display: none; margin-top: 15px;"></div>
        </div>
    </div>

    <div id="forgotPasswordModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeForgotPasswordModal()">&times;</span>
            <h2 style="color: #1e293b; margin-bottom: 10px;">Recuperar Senha</h2>
            <p style="color: #64748b; margin-bottom: 20px;" id="forgot-subtitle">Escolha como deseja recuperar sua senha</p>

            <!-- Toggle Email/Telefone -->
            <div class="auth-type-toggle" style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button type="button" id="forgot-email-toggle" onclick="toggleForgotType('email')" style="flex: 1; padding: 10px; border: 2px solid #4f46e5; background: #4f46e5; color: white; border-radius: 8px; font-weight: 500; cursor: pointer;">
                    Email
                </button>
                <button type="button" id="forgot-phone-toggle" onclick="toggleForgotType('phone')" style="flex: 1; padding: 10px; border: 2px solid #e2e8f0; background: white; color: #64748b; border-radius: 8px; font-weight: 500; cursor: pointer;">
                    WhatsApp
                </button>
            </div>

            <!-- Formulário Email -->
            <form onsubmit="handleForgotPassword(event)" id="forgot-email-form">
                <div class="form-group">
                    <label for="forgot-email">Email</label>
                    <input type="email" id="forgot-email" required>
                </div>
                <button type="submit" class="btn" id="forgot-btn">Enviar Link de Recuperação</button>
            </form>

            <!-- Formulário Telefone -->
            <form onsubmit="handleForgotPasswordPhone(event)" id="forgot-phone-form" style="display: none;">
                <div class="form-group">
                    <label for="forgot-phone">Telefone</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" value="+55" readonly class="phone-prefix">
                        <input type="tel" id="forgot-phone" placeholder="11999999999" pattern="[0-9]{10,11}" maxlength="11" style="flex: 1;" required>
                    </div>
                </div>
                <button type="submit" class="btn" id="forgot-phone-btn">Enviar Código via WhatsApp</button>
            </form>

            <!-- Formulário de verificação do código (telefone) -->
            <form onsubmit="handleResetPasswordPhone(event)" id="forgot-verify-form" style="display: none;">
                <p style="color: #64748b; margin-bottom: 15px; font-size: 14px;">Digite o código de 6 dígitos enviado para seu WhatsApp</p>
                <div class="form-group">
                    <label for="forgot-verify-code">Código de Verificação</label>
                    <input type="text" id="forgot-verify-code" placeholder="000000" maxlength="6" pattern="[0-9]{6}" required style="text-align: center; font-size: 24px; letter-spacing: 8px;">
                </div>
                <div class="form-group">
                    <label for="forgot-new-password">Nova Senha</label>
                    <input type="password" id="forgot-new-password" minlength="6" required placeholder="Mínimo 6 caracteres">
                </div>
                <div class="form-group">
                    <label for="forgot-confirm-password">Confirmar Nova Senha</label>
                    <input type="password" id="forgot-confirm-password" minlength="6" required>
                </div>
                <button type="submit" class="btn" id="forgot-reset-btn">Redefinir Senha</button>
                <div style="text-align: center; margin-top: 10px;">
                    <a href="#" onclick="resendForgotCode(event)" style="color: #4f46e5; text-decoration: none; font-size: 14px;">Reenviar código</a>
                </div>
            </form>

            <div id="forgot-message" class="message"></div>

            <div style="text-align: center; margin-top: 15px;">
                <a href="#" onclick="backToLogin(event)" style="color: #4f46e5; text-decoration: none; font-size: 14px;">Voltar ao Login</a>
            </div>
        </div>
    </div>

    <!-- Modal de Anúncio/Manutenção -->
    <div id="announcementModal" class="modal" style="display: none;">
        <div class="modal-content announcement-modal">
            <span class="close" onclick="closeAnnouncementModal()">&times;</span>
            <div class="announcement-modal-header" id="announcementModalHeader">
                <div class="announcement-modal-icon" id="announcementModalIcon"></div>
                <h2 id="announcementModalTitle"></h2>
            </div>
            <div class="announcement-modal-body">
                <p id="announcementModalMessage"></p>
                <p class="announcement-modal-date" id="announcementModalDate"></p>
            </div>
            <button class="btn" onclick="closeAnnouncementModal()" style="margin-top: 20px;">Entendi</button>
        </div>
    </div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLoginModal()">&times;</span>
            <h2 style="color: #1e293b; margin-bottom: 10px;">Bem-vindo</h2>
            <p style="color: #64748b; margin-bottom: 30px;">Faça login ou crie sua conta</p>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('login')">Login</div>
                <div class="tab" onclick="switchTab('register')">Cadastro</div>
            </div>

            <!-- LOGIN FORM -->
            <div id="login-form" class="form-content active">
                <!-- Toggle Email/Telefone -->
                <div class="auth-type-toggle" style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button type="button" class="auth-toggle-btn active" id="login-email-toggle" onclick="toggleLoginType('email')" style="flex: 1; padding: 10px; border: 2px solid #4f46e5; background: #4f46e5; color: white; border-radius: 8px; font-weight: 500; cursor: pointer;">
                        Email
                    </button>
                    <button type="button" class="auth-toggle-btn" id="login-phone-toggle" onclick="toggleLoginType('phone')" style="flex: 1; padding: 10px; border: 2px solid #e2e8f0; background: white; color: #64748b; border-radius: 8px; font-weight: 500; cursor: pointer;">
                        Telefone
                    </button>
                </div>

                <form onsubmit="handleLogin(event)">
                    <!-- Campo Email -->
                    <div class="form-group" id="login-email-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email">
                    </div>

                    <!-- Campo Telefone -->
                    <div class="form-group" id="login-phone-group" style="display: none;">
                        <label for="login-phone">Telefone</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" value="+55" readonly class="phone-prefix">
                            <input type="tel" id="login-phone" placeholder="11999999999" pattern="[0-9]{10,11}" maxlength="11" style="flex: 1;">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="login-password">Senha</label>
                        <div class="password-wrapper">
                            <input type="password" id="login-password" class="password-input" required>
                            <span class="toggle-password" onclick="togglePassword('login-password')">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                </svg>
                            </span>
                        </div>
                    </div>

                    <button type="submit" class="btn" id="login-btn">Entrar</button>
                </form>
                <div style="text-align: center; margin-top: 15px;">
                    <a href="#" onclick="openForgotPasswordModal(event)" style="color: #4f46e5; text-decoration: none; font-size: 14px;">Esqueceu sua senha?</a>
                </div>
                <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                    <p style="color: #64748b; font-size: 13px; margin: 0;">
                        Ainda não tem conta? <a href="#" onclick="switchTab('register'); return false;" style="color: #10b981; font-weight: 600; text-decoration: none;">Cadastre-se e ganhe 5 mensagens grátis</a>
                    </p>
                </div>
            </div>

            <!-- REGISTER FORM -->
            <div id="register-form" class="form-content">
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 18px; margin-bottom: 20px; border-radius: 8px; color: white;">
                    <p style="font-size: 15px; margin: 0 0 8px 0; font-weight: 600;">
                        Bônus de Boas-Vindas
                    </p>
                    <p style="font-size: 14px; margin: 0; opacity: 0.95;">
                        <strong>5 mensagens grátis</strong> para testar a plataforma
                    </p>
                </div>

                <!-- Toggle Email/Telefone -->
                <div class="auth-type-toggle" style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button type="button" class="auth-toggle-btn active" id="register-email-toggle" onclick="toggleRegisterType('email')" style="flex: 1; padding: 10px; border: 2px solid #4f46e5; background: #4f46e5; color: white; border-radius: 8px; font-weight: 500; cursor: pointer;">
                        Email
                    </button>
                    <button type="button" class="auth-toggle-btn" id="register-phone-toggle" onclick="toggleRegisterType('phone')" style="flex: 1; padding: 10px; border: 2px solid #e2e8f0; background: white; color: #64748b; border-radius: 8px; font-weight: 500; cursor: pointer;">
                        Telefone
                    </button>
                </div>

                <form onsubmit="handleRegister(event)" id="register-form-element">
                    <!-- Campo Nome -->
                    <div class="form-group">
                        <label for="register-name">Nome completo *</label>
                        <input type="text" id="register-name" required placeholder="Seu nome completo" minlength="3">
                    </div>

                    <!-- Campo CPF (desativado)
                    <div class="form-group">
                        <label for="register-cpf">CPF <span style="font-weight: 400; color: #94a3b8; font-size: 12px;">(opcional)</span></label>
                        <input type="text" id="register-cpf" placeholder="000.000.000-00" maxlength="14" oninput="maskCPF(this)">
                        <small style="color: #94a3b8; font-size: 11px; margin-top: 4px; display: block;">Utilizado apenas para segurança e conformidade legal</small>
                    </div>
                    -->

                    <!-- Campo Email -->
                    <div class="form-group" id="register-email-group">
                        <label for="register-email">Email *</label>
                        <input type="email" id="register-email" required>
                    </div>

                    <!-- Campo Telefone -->
                    <div class="form-group" id="register-phone-group" style="display: none;">
                        <label for="register-phone">Telefone *</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" value="+55" readonly class="phone-prefix">
                            <input type="tel" id="register-phone" placeholder="11999999999" pattern="[0-9]{10,11}" maxlength="11" style="flex: 1;">
                        </div>
                        <p class="hint">Digite DDD + número (ex: 11999999999)</p>
                    </div>

                    <div class="form-group">
                        <label for="register-password">Senha *</label>
                        <div class="password-wrapper">
                            <input type="password" id="register-password" class="password-input" required minlength="6">
                            <span class="toggle-password" onclick="togglePassword('register-password')">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                </svg>
                            </span>
                        </div>
                        <p class="hint">Mínimo 6 caracteres</p>
                    </div>

                    <div class="form-group">
                        <label for="register-password-confirm">Confirmar Senha *</label>
                        <div class="password-wrapper">
                            <input type="password" id="register-password-confirm" class="password-input" required>
                            <span class="toggle-password" onclick="togglePassword('register-password-confirm')">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                </svg>
                            </span>
                        </div>
                    </div>

                    <!-- Aceite dos Termos -->
                    <div class="form-group" style="margin-top: 15px;">
                        <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer; font-weight: normal; font-size: 13px; color: #475569;">
                            <input type="checkbox" id="accept-terms" required style="margin-top: 3px; width: 18px; height: 18px; cursor: pointer; accent-color: #4f46e5;">
                            <span>
                                Li e aceito os <a href="/terms" target="_blank" style="color: #4f46e5; text-decoration: underline; font-weight: 600;">Termos de Uso</a>
                                e a <a href="/privacy" target="_blank" style="color: #4f46e5; text-decoration: underline; font-weight: 600;">Política de Privacidade</a>.
                                O uso da plataforma deve respeitar a legislação vigente.
                            </span>
                        </label>
                    </div>

                    <button type="submit" class="btn" id="register-btn">Criar conta e ganhar 5 mensagens</button>
                </form>
            </div>

            <!-- VERIFY PHONE CODE FORM -->
            <div id="verify-phone-form" class="form-content" style="display: none;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 48px; margin-bottom: 15px;">💬</div>
                    <h3 style="color: #1e293b; margin-bottom: 10px;">Verificar Telefone</h3>
                    <p style="color: #64748b; font-size: 14px;">Digite o código de 6 dígitos enviado pelo WhatsApp para</p>
                    <p style="color: #4f46e5; font-weight: 600;" id="verify-phone-display"></p>
                </div>

                <form onsubmit="handleVerifyPhone(event)">
                    <div class="form-group">
                        <label for="verify-code">Código de Verificação</label>
                        <input type="text" id="verify-code" placeholder="000000" maxlength="6" pattern="[0-9]{6}" style="text-align: center; font-size: 24px; letter-spacing: 8px; font-weight: 600;" required>
                    </div>

                    <button type="submit" class="btn" id="verify-btn">Verificar</button>
                </form>

                <div style="text-align: center; margin-top: 15px;">
                    <a href="#" onclick="resendPhoneCode(event)" style="color: #4f46e5; text-decoration: none; font-size: 14px;">Reenviar código</a>
                </div>

                <div style="text-align: center; margin-top: 10px;">
                    <a href="#" onclick="backToRegister(event)" style="color: #64748b; text-decoration: none; font-size: 14px;">Voltar</a>
                </div>
            </div>

            <div id="modal-message" class="message"></div>
        </div>
    </div>


    <script src="config.js"></script>
    <script src="api.js"></script>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

    <script>
        // Dark Mode Functions
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark-mode');
            const isDark = document.documentElement.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            updateThemeIcon(isDark);
        }

        function updateThemeIcon(isDark) {
            const icon = document.getElementById('theme-icon');
            if (icon) {
                icon.textContent = isDark ? '☀️' : '🌙';
            }
        }

        // Aplicar tema salvo ao carregar
        (function initDarkMode() {
            const savedTheme = localStorage.getItem('darkMode');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const isDark = savedTheme === 'true' || (savedTheme === null && prefersDark);
            if (isDark) {
                document.documentElement.classList.add('dark-mode');
            }
            // Atualizar ícone após DOM carregar
            document.addEventListener('DOMContentLoaded', () => updateThemeIcon(isDark));
        })();

        function formatDateBR(dateString) {
            const date = new Date(dateString);
            date.setHours(date.getHours() - 3);
            return date.toLocaleString('pt-BR');
        }

        let token = localStorage.getItem('token');
        let user = JSON.parse(localStorage.getItem('user') || 'null');
        let selectedQuantity = 0;
        let selectedChannel = 'whatsapp';
        let selectedCreditType = 'whatsapp';
        let repliesPollingInterval = null;
        let socket = null;

      
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let recordingStartTime = null;
        let recordingTimer = null;
        let currentAudioBlob = null;
        let currentAudioBase64 = null;
        let currentAudioMimetype = null;

  
        let currentLoginType = 'email';
        let currentRegisterType = 'email';
        let pendingPhoneVerification = null;

    
        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

              
                const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
                    ? 'audio/webm;codecs=opus'
                    : 'audio/webm';

                mediaRecorder = new MediaRecorder(stream, { mimeType });
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    processAudioBlob(audioBlob, mimeType);

                   
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                recordingStartTime = Date.now();

                
                const recordBtn = document.getElementById('record-btn');
                const micIcon = document.getElementById('mic-icon');
                const stopIcon = document.getElementById('stop-icon');
                const recordingIndicator = document.getElementById('recording-indicator');

                recordBtn.classList.add('recording');
                micIcon.style.display = 'none';
                stopIcon.style.display = 'block';
                recordingIndicator.style.display = 'flex';

             
                updateRecordingTime();
                recordingTimer = setInterval(updateRecordingTime, 1000);

            } catch (error) {
                console.error('Erro ao acessar microfone:', error);
                showMessage('send-message', 'Não foi possível acessar o microfone. Verifique as permissões.', 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;

               
                if (recordingTimer) {
                    clearInterval(recordingTimer);
                    recordingTimer = null;
                }

               
                const recordBtn = document.getElementById('record-btn');
                const micIcon = document.getElementById('mic-icon');
                const stopIcon = document.getElementById('stop-icon');
                const recordingIndicator = document.getElementById('recording-indicator');

                recordBtn.classList.remove('recording');
                micIcon.style.display = 'block';
                stopIcon.style.display = 'none';
                recordingIndicator.style.display = 'none';
            }
        }

        function updateRecordingTime() {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const seconds = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('recording-time').textContent = `${minutes}:${seconds}`;
        }

        function handleAudioUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            
            if (file.size > 16 * 1024 * 1024) {
                showMessage('send-message', 'Arquivo muito grande. Máximo: 16MB', 'error');
                event.target.value = '';
                return;
            }

           
            if (!file.type.startsWith('audio/')) {
                showMessage('send-message', 'Por favor, selecione um arquivo de áudio válido.', 'error');
                event.target.value = '';
                return;
            }

            processAudioBlob(file, file.type);
        }

        function processAudioBlob(blob, mimetype) {
            currentAudioBlob = blob;
            currentAudioMimetype = mimetype;

          
            const reader = new FileReader();
            reader.onloadend = () => {
               
                currentAudioBase64 = reader.result.split(',')[1];

              
                const previewContainer = document.getElementById('audio-preview-container');
                const audioPreview = document.getElementById('audio-preview');

                audioPreview.src = URL.createObjectURL(blob);
                previewContainer.style.display = 'flex';
            };
            reader.readAsDataURL(blob);
        }

        function removeAudio() {
            currentAudioBlob = null;
            currentAudioBase64 = null;
            currentAudioMimetype = null;

            const previewContainer = document.getElementById('audio-preview-container');
            const audioPreview = document.getElementById('audio-preview');

            previewContainer.style.display = 'none';
            audioPreview.src = '';
        }

       
        function toggleEmojis() {
            const emojiBar = document.getElementById('emoji-bar');
            emojiBar.classList.toggle('show');
        }

        function addEmoji(emoji) {
            const textarea = document.getElementById('message');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;

            textarea.value = text.substring(0, start) + emoji + text.substring(end);
            textarea.focus();
            textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
        }

     
        let lastSentPhone = null;
        let favoritesCache = [];

        function getFavoriteDisplayName(phone) {
          
            const normalizedPhone = phone.replace(/^\+55/, '').replace(/\D/g, '');

            const favorite = favoritesCache.find(fav => {
                const favPhone = fav.phone.replace(/\D/g, '');
                return favPhone === normalizedPhone || favPhone === phone.replace(/\D/g, '');
            });

            if (favorite) {
                return `${favorite.name} (${phone})`;
            }
            return phone;
        }

        async function loadFavorites() {
            if (!token) return [];

            try {
                const response = await API.get('/api/favorites', token);
                const data = await response.json();

                if (data.success) {
                    favoritesCache = data.favorites;
                    return data.favorites;
                }
                return [];
            } catch (error) {
                console.error('Erro ao carregar favoritos:', error);
                return [];
            }
        }

        async function updateFavoritesSelect() {
            const select = document.getElementById('favorites-select');
            if (!select) return;

            const favorites = await loadFavorites();
            select.innerHTML = '<option value="">Selecionar favorito...</option>';

            favorites.forEach((fav) => {
                const option = document.createElement('option');
                option.value = fav.id;
                option.textContent = `${fav.name} (${fav.phone})`;
                select.appendChild(option);
            });
        }

        function selectFavorite(id) {
            if (id === '') return;

            const fav = favoritesCache.find(f => f.id == id);

            if (fav) {
                document.getElementById('phone').value = fav.phone;
                document.getElementById('favorites-select').value = '';
            }
        }

        async function openFavoritesModal() {
            await renderFavoritesList();
            document.getElementById('favorites-modal').classList.add('show');
        }

        function closeFavoritesModal() {
            document.getElementById('favorites-modal').classList.remove('show');
            document.getElementById('new-favorite-name').value = '';
            document.getElementById('new-favorite-phone').value = '';
        }

        function closeFavoritesModalOnBackdrop(event) {
            if (event.target.id === 'favorites-modal') {
                closeFavoritesModal();
            }
        }

        async function renderFavoritesList() {
            const container = document.getElementById('favorites-list');
            const favorites = await loadFavorites();

            if (favorites.length === 0) {
                container.innerHTML = '<div class="favorites-empty">Nenhum favorito salvo ainda.</div>';
                return;
            }

            container.innerHTML = favorites.map((fav) => `
                <div class="favorite-item">
                    <div class="favorite-item-info">
                        <div class="favorite-item-name">${fav.name}</div>
                        <div class="favorite-item-phone">+55 ${fav.phone}</div>
                    </div>
                    <div class="favorite-item-actions">
                        <button class="favorite-item-btn use" onclick="useFavorite(${fav.id})">Usar</button>
                        <button class="favorite-item-btn delete" onclick="deleteFavoriteById(${fav.id})">Excluir</button>
                    </div>
                </div>
            `).join('');
        }

        async function addFavorite() {
            const nameInput = document.getElementById('new-favorite-name');
            const phoneInput = document.getElementById('new-favorite-phone');

            const name = nameInput.value.trim();
            const phone = phoneInput.value.replace(/\D/g, '');

            if (!name) {
                showAlert('Digite um nome para o favorito', 'warning');
                return;
            }

            if (phone.length < 10 || phone.length > 11) {
                showAlert('Digite um telefone válido (10 ou 11 dígitos)', 'warning');
                return;
            }

            try {
                const response = await API.post('/api/favorites', { name, phone }, token);
                const data = await response.json();

                if (data.success) {
                    nameInput.value = '';
                    phoneInput.value = '';
                    await renderFavoritesList();
                    await updateFavoritesSelect();
                    showAlert('Favorito adicionado com sucesso!', 'success');
                } else {
                    showAlert(data.error || 'Erro ao adicionar favorito', 'error');
                }
            } catch (error) {
                showAlert('Erro ao adicionar favorito: ' + error.message, 'error');
            }
        }

        function useFavorite(id) {
            const fav = favoritesCache.find(f => f.id == id);

            if (fav) {
                document.getElementById('phone').value = fav.phone;
                closeFavoritesModal();
            }
        }

        async function deleteFavoriteById(id) {
            const confirmed = await showConfirm('Tem certeza que deseja excluir este favorito?', 'Excluir Favorito');
            if (!confirmed) return;

            try {
                const response = await API.delete('/api/favorites/' + id, token);
                const data = await response.json();

                if (data.success) {
                    await renderFavoritesList();
                    await updateFavoritesSelect();
                    showAlert('Favorito excluído com sucesso!', 'success');
                } else {
                    showAlert(data.error || 'Erro ao excluir favorito', 'error');
                }
            } catch (error) {
                showAlert('Erro ao excluir favorito: ' + error.message, 'error');
            }
        }

        async function showSavePrompt(phone) {
            if (!token) return;

         
            try {
                const response = await API.get('/api/favorites/check/' + phone, token);
                const data = await response.json();

                if (data.isFavorite) return;

                lastSentPhone = phone;
                document.getElementById('save-favorite-name').value = '';
                document.getElementById('save-favorite-prompt').classList.add('show');
            } catch (error) {
                console.error('Erro ao verificar favorito:', error);
            }
        }

        function closeSavePrompt() {
            document.getElementById('save-favorite-prompt').classList.remove('show');
            lastSentPhone = null;
        }

        async function saveFavoriteFromPrompt() {
            const nameInput = document.getElementById('save-favorite-name');
            const name = nameInput.value.trim();

            if (!name) {
                showAlert('Digite um nome para o contato', 'warning');
                return;
            }

            if (!lastSentPhone) return;

            try {
                const response = await API.post('/api/favorites', { name, phone: lastSentPhone }, token);
                const data = await response.json();

                if (data.success) {
                    await updateFavoritesSelect();
                    closeSavePrompt();
                    showAlert('Contato salvo nos favoritos!', 'success');
                } else {
                    showAlert(data.error || 'Erro ao salvar favorito', 'error');
                }
            } catch (error) {
                showAlert('Erro ao salvar favorito: ' + error.message, 'error');
            }
        }

   
        let customModalResolve = null;

        function showAlert(message, type = 'info') {
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };
            const titles = {
                success: 'Sucesso!',
                error: 'Erro',
                warning: 'Atenção',
                info: 'Informação'
            };
            const btnClass = type === 'error' ? 'danger' : type === 'success' ? 'success' : 'primary';

            document.getElementById('custom-modal-icon').textContent = icons[type] || icons.info;
            document.getElementById('custom-modal-title').textContent = titles[type] || titles.info;
            document.getElementById('custom-modal-message').textContent = message;
            document.getElementById('custom-modal-buttons').innerHTML = `
                <button class="custom-modal-btn ${btnClass}" onclick="closeCustomModal()">OK</button>
            `;
            document.getElementById('custom-modal').classList.add('show');
        }

        function showConfirm(message, title = 'Confirmar') {
            return new Promise((resolve) => {
                customModalResolve = resolve;
                document.getElementById('custom-modal-icon').textContent = '❓';
                document.getElementById('custom-modal-title').textContent = title;
                document.getElementById('custom-modal-message').textContent = message;
                document.getElementById('custom-modal-buttons').innerHTML = `
                    <button class="custom-modal-btn secondary" onclick="resolveCustomModal(false)">Cancelar</button>
                    <button class="custom-modal-btn danger" onclick="resolveCustomModal(true)">Confirmar</button>
                `;
                document.getElementById('custom-modal').classList.add('show');
            });
        }

        function closeCustomModal() {
            document.getElementById('custom-modal').classList.remove('show');
        }

        function resolveCustomModal(value) {
            document.getElementById('custom-modal').classList.remove('show');
            if (customModalResolve) {
                customModalResolve(value);
                customModalResolve = null;
            }
        }

        function closeCustomModalOnBackdrop(event) {
            if (event.target.id === 'custom-modal') {
                closeCustomModal();
                if (customModalResolve) {
                    customModalResolve(false);
                    customModalResolve = null;
                }
            }
        }

        function showSuccessRegistration(email) {
            document.getElementById('custom-modal-icon').textContent = '🎉';
            document.getElementById('custom-modal-title').textContent = 'Conta Criada com Sucesso!';
            document.getElementById('custom-modal-message').innerHTML = `
                <div style="text-align: left; line-height: 1.8;">
                    <p style="margin-bottom: 12px;">📧 Um email de verificação foi enviado para:</p>
                    <p style="font-weight: 600; color: #4f46e5; margin-bottom: 16px;">${email}</p>
                    <p style="font-weight: 600; margin-bottom: 8px;">⚠️ IMPORTANTE:</p>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li>Verifique sua caixa de entrada (e spam)</li>
                        <li>Clique no link de verificação</li>
                        <li>Só então você poderá fazer login</li>
                    </ul>
                </div>
            `;
            document.getElementById('custom-modal-buttons').innerHTML = `
                <button class="custom-modal-btn success" onclick="closeCustomModal()">Entendi</button>
            `;
            document.getElementById('custom-modal').classList.add('show');
        }
   

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const toggle = event.currentTarget;

            if (input.type === 'password') {
                input.type = 'text';
                toggle.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>';
            } else {
                input.type = 'password';
                toggle.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>';
            }
        }

      
        let currentAnnouncement = null;
        let announcementDismissed = false;

        async function loadAnnouncement() {
            try {
                const response = await API.get('/api/announcement');
                const data = await response.json();

                if (data.success && data.announcement) {
                    currentAnnouncement = data.announcement;
                    showAnnouncementBanner(data.announcement);

                  
                    const dismissedId = sessionStorage.getItem('announcementDismissed');
                    if (dismissedId !== data.announcement.created_at) {
                        showAnnouncementModal(data.announcement);
                    }
                } else {
                    hideAnnouncementBanner();
                }
            } catch (error) {
                console.error('Erro ao carregar anúncio:', error);
            }
        }

        function showAnnouncementBanner(announcement) {
            const banner = document.getElementById('announcementBanner');
            const icon = document.getElementById('announcementBannerIcon');
            const title = document.getElementById('announcementBannerTitle');
            const message = document.getElementById('announcementBannerMessage');

            const icons = {
                'maintenance': '🔧',
                'warning': '⚠️',
                'announcement': '📢'
            };

            banner.className = 'announcement-banner ' + announcement.type;
            icon.textContent = icons[announcement.type] || '📢';
            title.textContent = announcement.title;
            message.textContent = announcement.message.length > 100
                ? announcement.message.substring(0, 100) + '...'
                : announcement.message;

            banner.style.display = 'block';
        }

        function hideAnnouncementBanner() {
            document.getElementById('announcementBanner').style.display = 'none';
        }

        function closeAnnouncementBanner() {
            hideAnnouncementBanner();
        }

        function showAnnouncementModal(announcement) {
            const modal = document.getElementById('announcementModal');
            const header = document.getElementById('announcementModalHeader');
            const icon = document.getElementById('announcementModalIcon');
            const title = document.getElementById('announcementModalTitle');
            const message = document.getElementById('announcementModalMessage');
            const date = document.getElementById('announcementModalDate');

            const icons = {
                'maintenance': '🔧',
                'warning': '⚠️',
                'announcement': '📢'
            };

            header.className = 'announcement-modal-header ' + announcement.type;
            icon.textContent = icons[announcement.type] || '📢';
            title.textContent = announcement.title;
            message.textContent = announcement.message;

            if (announcement.expires_at) {
                const expiresDate = new Date(announcement.expires_at);
                date.textContent = 'Válido até: ' + expiresDate.toLocaleString('pt-BR');
            } else {
                date.textContent = '';
            }

            modal.style.display = 'block';
        }

        function closeAnnouncementModal() {
            document.getElementById('announcementModal').style.display = 'none';
      
            if (currentAnnouncement) {
                sessionStorage.setItem('announcementDismissed', currentAnnouncement.created_at);
            }
        }

        function updateUI() {
            const navButtons = document.getElementById('navbar-buttons');
            const welcomeSection = document.getElementById('welcome-section');
            const mainSection = document.getElementById('main-section');

            if (token && user) {
                const userIdentifier = user.email || user.phone || 'Usuário';
               
                let displayName = 'Usuário';
                if (user.name) {
                    displayName = user.name.split(' ')[0]; 
                } else if (user.email) {
                    displayName = user.email.split('@')[0];
                } else if (user.phone) {
                    displayName = user.phone;
                }
                navButtons.innerHTML = `
                    <button class="btn-theme-toggle" onclick="toggleDarkMode()" title="Alternar tema">
                        <span id="theme-icon">${document.documentElement.classList.contains('dark-mode') ? '☀️' : '🌙'}</span>
                    </button>
                    <div class="notification-dropdown" id="notificationDropdown">
                        <button class="notification-btn" onclick="toggleNotificationDropdown()">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="24" height="24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                            </svg>
                            <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                        </button>
                        <div class="notification-dropdown-content" id="notificationContent">
                            <div class="notification-header">
                                <strong>Notificações</strong>
                                <button class="mark-all-read-btn" onclick="markAllNotificationsRead()">Marcar todas como lidas</button>
                            </div>
                            <div class="notification-list" id="notificationList">
                                <div class="notification-empty">Nenhuma notificação</div>
                            </div>
                        </div>
                    </div>
                    <div class="user-dropdown" id="userDropdown">
                        <button class="user-dropdown-btn" onclick="toggleUserDropdown()">
                            <span>${displayName}</span>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div class="user-dropdown-content">
                            <div class="user-dropdown-header">
                                <strong>${displayName}</strong>
                                <span>${userIdentifier}</span>
                            </div>
                            <button class="user-dropdown-item" onclick="handleAccessData(); closeUserDropdown();">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                                Acessar Dados
                            </button>
                            <button class="user-dropdown-item" onclick="handleExportData(); closeUserDropdown();">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                Exportar Dados
                            </button>
                            <button class="user-dropdown-item" onclick="handleCorrectData(); closeUserDropdown();">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                                Alterar Dados
                            </button>
                            <div class="user-dropdown-divider"></div>
                            <button class="user-dropdown-item danger" onclick="handleDeleteAccount(); closeUserDropdown();">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                Excluir Conta
                            </button>
                        </div>
                    </div>
                    <button class="btn-nav" onclick="logout()">Sair</button>
                `;
                welcomeSection.classList.add('hidden');
                mainSection.classList.remove('hidden');
                loadUserData();
          
                updateFavoritesSelect().then(() => {
                    loadHistory();
                    loadReplies();
                });
                loadPaymentHistory();
                connectSocket();
                startRepliesPolling();
                checkWhatsAppStatus();
                loadAnnouncement();
                loadNotifications();
            } else {
                navButtons.innerHTML = `
                    <button class="btn-theme-toggle" onclick="toggleDarkMode()" title="Alternar tema">
                        <span id="theme-icon">${document.documentElement.classList.contains('dark-mode') ? '☀️' : '🌙'}</span>
                    </button>
                    <button class="btn-nav" onclick="openLoginModal()">Entrar / Cadastrar</button>
                `;
                welcomeSection.classList.remove('hidden');
                mainSection.classList.add('hidden');
                disconnectSocket();
                stopRepliesPolling();
            }
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('active');
        }

        function closeUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            if (dropdown) {
                dropdown.classList.remove('active');
            }
        }

     
        function toggleNotificationDropdown() {
            const dropdown = document.getElementById('notificationDropdown');
            const userDropdown = document.getElementById('userDropdown');
            if (userDropdown) userDropdown.classList.remove('active');
            dropdown.classList.toggle('active');
        }

        function closeNotificationDropdown() {
            const dropdown = document.getElementById('notificationDropdown');
            if (dropdown) {
                dropdown.classList.remove('active');
            }
        }

        async function loadNotifications() {
            if (!token) return;

            try {
        
                const countResponse = await API.get('/api/user/notifications/unread-count', token);
                const countData = await countResponse.json();
                updateNotificationBadge(countData.count || 0);

       
                const response = await API.get('/api/user/notifications', token);
                const data = await response.json();

                if (data.success) {
                    renderNotifications(data.notifications || []);
                }
            } catch (error) {
                console.error('Erro ao carregar notificações:', error);
            }
        }

        function updateNotificationBadge(count) {
            const badge = document.getElementById('notificationBadge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count > 99 ? '99+' : count;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        function renderNotifications(notifications) {
            const list = document.getElementById('notificationList');
            if (!list) return;

            if (!notifications || notifications.length === 0) {
                list.innerHTML = '<div class="notification-empty">Nenhuma notificação</div>';
                return;
            }

            list.innerHTML = notifications.map(notif => {
                const isBlocked = notif.type === 'blocked';
                const icon = isBlocked ? '🚫' : '✅';
                const iconClass = isBlocked ? 'blocked' : 'unblocked';
                const timeAgo = formatTimeAgo(notif.created_at);

                return `
                    <div class="notification-item ${notif.read ? '' : 'unread'}" onclick="handleNotificationClick(${notif.id}, ${notif.read})">
                        <div class="notification-icon ${iconClass}">${icon}</div>
                        <div class="notification-body">
                            <div class="notification-title">${notif.title}</div>
                            <div class="notification-message">${notif.message}</div>
                            <div class="notification-time">${timeAgo}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            if (seconds < 60) return 'Agora';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} min atrás`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h atrás`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)} dias atrás`;
            return date.toLocaleDateString('pt-BR');
        }

        async function handleNotificationClick(notificationId, isRead) {
            if (!isRead && token) {
                try {
                    await API.post(`/api/user/notifications/${notificationId}/read`, {}, token);
                    loadNotifications();
                } catch (error) {
                    console.error('Erro ao marcar notificação como lida:', error);
                }
            }
        }

        async function markAllNotificationsRead() {
            if (!token) return;

            try {
                await API.post('/api/user/notifications/read-all', {}, token);
                loadNotifications();
            } catch (error) {
                console.error('Erro ao marcar todas como lidas:', error);
            }
        }

       
        document.addEventListener('click', function(event) {
            const userDropdown = document.getElementById('userDropdown');
            const notifDropdown = document.getElementById('notificationDropdown');

            if (userDropdown && !userDropdown.contains(event.target)) {
                userDropdown.classList.remove('active');
            }
            if (notifDropdown && !notifDropdown.contains(event.target)) {
                notifDropdown.classList.remove('active');
            }
        });

        async function loadUserData() {
            if (!token) return;

            try {
                const response = await API.get('/api/user/profile', token);

                if (response.status === 401 || response.status === 500) {
                
                    logout();
                    return;
                }

                const data = await response.json();
                if (data.success) {

                    user = { ...user, ...data.user };
                    localStorage.setItem('user', JSON.stringify(user));

                    updateCreditsDisplay(data.user.whatsapp_credits, data.user.sms_credits);


                    updateDisplayName();

                } else {

                    logout();
                }
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                logout();
            }
        }

        function updateDisplayName() {
         
            let displayName = 'Usuário';
            if (user && user.name) {
                displayName = user.name.split(' ')[0];
            } else if (user && user.email) {
                displayName = user.email.split('@')[0];
            } else if (user && user.phone) {
                displayName = user.phone;
            }

            const dropdownBtn = document.querySelector('.user-dropdown-btn span');
            const dropdownHeader = document.querySelector('.user-dropdown-header strong');
            if (dropdownBtn) dropdownBtn.textContent = displayName;
            if (dropdownHeader) dropdownHeader.textContent = displayName;
        }

        function updateCreditsDisplay(whatsappCredits, smsCredits) {
            document.getElementById('credits-send-whatsapp').textContent = whatsappCredits;
        }

        async function checkWhatsAppStatus() {
            const indicator = document.getElementById('whatsapp-status-indicator');
            try {
                const response = await API.get('/api/whatsapp/available', token);
                const data = await response.json();

                if (data.success && data.available) {
                    indicator.style.display = 'none';
                } else {
                    indicator.style.display = 'block';
                    indicator.className = 'message error';
                    indicator.innerHTML = 'Sistema temporariamente offline. Tente novamente em alguns minutos.';
                }
            } catch (error) {
                indicator.style.display = 'block';
                indicator.className = 'message error';
                indicator.innerHTML = 'Erro ao verificar status do WhatsApp';
            }
        }

        function hideWhatsAppStatus() {
            const indicator = document.getElementById('whatsapp-status-indicator');
            indicator.style.display = 'none';
        }

        async function loadHistory() {
            if (!token) return;

            try {
                const response = await API.get('/api/messages', token);

                const data = await response.json();
                const historyList = document.getElementById('history-list');

                if (data.success && data.messages.length > 0) {
                    historyList.innerHTML = data.messages.map(msg => {
                        const hasReply = msg.has_reply ? '<span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px;">Respondida</span>' : '';
                        const displayPhone = getFavoriteDisplayName(msg.phone);
                        return `
                            <div class="history-item">
                                <div class="date">${formatDateBR(msg.created_at)}${hasReply}</div>
                                <div class="details">
                                    <strong>Para:</strong> ${displayPhone}<br>
                                    <strong>Mensagem:</strong> ${msg.message}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    historyList.innerHTML = '<p style="text-align: center; color: #999;">Nenhuma mensagem enviada ainda</p>';
                }
            } catch (error) {
                console.error('Erro ao carregar histórico:', error);
            }
        }

        async function loadReplies() {
            if (!token) return;

            const repliesList = document.getElementById('replies-list');

            try {
                const response = await API.get('/api/replies', token);

                const data = await response.json();

                if (data.success && data.replies && data.replies.length > 0) {
                    repliesList.innerHTML = data.replies.map(reply => {
                      
                        const hasAudio = reply.audio_url && reply.audio_url.length > 0;
                        const audioPlayer = hasAudio ? `
                            <div class="reply-audio-player">
                                <span class="audio-badge">🎤 Mensagem de áudio</span>
                                <audio controls src="${reply.audio_url}" preload="metadata"></audio>
                            </div>
                        ` : '';

                        const displayFromPhone = getFavoriteDisplayName(reply.from_phone);
                        return `
                            <div class="history-item reply-item">
                                <div class="date">
                                    <span style="background: #4f46e5; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-right: 8px;">Nova</span>
                                    ${hasAudio ? '<span class="audio-badge" style="margin-right: 8px;">🎤 Áudio</span>' : ''}
                                    ${formatDateBR(reply.created_at)}
                                </div>
                                <div class="details">
                                    <strong>De:</strong> ${displayFromPhone}<br>
                                    <strong>Resposta:</strong> ${reply.message}
                                </div>
                                ${audioPlayer}
                                ${reply.original_message ? `<div style="margin-top: 10px; padding: 10px; background: #f8fafc; border-radius: 6px; border-left: 3px solid #cbd5e1;">
                                    <small style="color: #64748b;">Em resposta a:</small><br>
                                    <span style="color: #475569; font-size: 13px;">${reply.original_message}</span>
                                </div>` : ''}
                            </div>
                        `;
                    }).join('');
                } else {
                    repliesList.innerHTML = `
                        <div style="text-align: center; padding: 30px 20px;">
                            <div style="font-size: 48px; margin-bottom: 15px;">📭</div>
                            <p style="color: #64748b; margin: 0;">Nenhuma resposta recebida ainda</p>
                            <p style="color: #94a3b8; font-size: 13px; margin-top: 8px;">Quando alguém responder suas mensagens, aparecerá aqui</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar respostas:', error);
                repliesList.innerHTML = `
                    <div style="text-align: center; padding: 30px 20px;">
                        <div style="font-size: 48px; margin-bottom: 15px;">📭</div>
                        <p style="color: #64748b; margin: 0;">Nenhuma resposta recebida ainda</p>
                        <p style="color: #94a3b8; font-size: 13px; margin-top: 8px;">Quando alguém responder suas mensagens, aparecerá aqui</p>
                    </div>
                `;
            }
        }

        async function loadPaymentHistory() {
            if (!token) return;

            const paymentHistoryEl = document.getElementById('payment-history');

            try {
                const response = await API.get('/api/transactions', token);
                const data = await response.json();

                if (data.success && data.transactions && data.transactions.length > 0) {
               
                    const purchases = data.transactions.filter(t => t.type === 'purchase');

                    if (purchases.length > 0) {
                        paymentHistoryEl.innerHTML = purchases.slice(0, 10).map(purchase => {
                            const date = new Date(purchase.created_at);
                            const formattedDate = date.toLocaleDateString('pt-BR', {
                                day: '2-digit',
                                month: '2-digit',
                                year: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });

                            const statusColor = '#10b981';
                            const statusIcon = '✓';

                            return `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f9fafb; border-radius: 8px; margin-bottom: 8px; font-size: 13px;">
                                    <div>
                                        <div style="color: #374151; font-weight: 500;">
                                            <span style="color: ${statusColor}; margin-right: 5px;">${statusIcon}</span>
                                            +${purchase.credits_added} créditos
                                        </div>
                                        <div style="color: #9ca3af; font-size: 11px; margin-top: 2px;">${formattedDate}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="color: #374151; font-weight: 600;">R$ ${purchase.price ? purchase.price.toFixed(2).replace('.', ',') : '0,00'}</div>
                                        <div style="color: ${statusColor}; font-size: 11px;">Aprovado</div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        paymentHistoryEl.innerHTML = `
                            <p style="text-align: center; color: #9ca3af; font-size: 13px; padding: 15px 0;">
                                Nenhuma compra realizada ainda
                            </p>
                        `;
                    }
                } else {
                    paymentHistoryEl.innerHTML = `
                        <p style="text-align: center; color: #9ca3af; font-size: 13px; padding: 15px 0;">
                            Nenhuma compra realizada ainda
                        </p>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar histórico de pagamentos:', error);
                paymentHistoryEl.innerHTML = `
                    <p style="text-align: center; color: #9ca3af; font-size: 13px; padding: 15px 0;">
                        Nenhuma compra realizada ainda
                    </p>
                `;
            }
        }

        function openLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
        }

        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
        }

        function openForgotPasswordModal(event) {
            event.preventDefault();
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('forgotPasswordModal').style.display = 'block';
        }

        function closeForgotPasswordModal() {
            document.getElementById('forgotPasswordModal').style.display = 'none';
          
            pendingPhoneReset = null;
            document.getElementById('forgot-verify-form').style.display = 'none';
            document.getElementById('forgot-email-form').style.display = currentForgotType === 'email' ? 'block' : 'none';
            document.getElementById('forgot-phone-form').style.display = currentForgotType === 'phone' ? 'block' : 'none';
            document.getElementById('forgot-message').style.display = 'none';
        }

        function backToLogin(event) {
            event.preventDefault();
            document.getElementById('forgotPasswordModal').style.display = 'none';
            document.getElementById('loginModal').style.display = 'block';
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.form-content').forEach(f => f.classList.remove('active'));

            if (tab === 'login') {
                document.querySelector('.tab:first-child').classList.add('active');
                document.getElementById('login-form').classList.add('active');
            } else {
                document.querySelector('.tab:last-child').classList.add('active');
                document.getElementById('register-form').classList.add('active');
            }

            document.getElementById('modal-message').style.display = 'none';
        }

  
        function toggleLoginType(type) {
            currentLoginType = type;
            const emailToggle = document.getElementById('login-email-toggle');
            const phoneToggle = document.getElementById('login-phone-toggle');
            const emailGroup = document.getElementById('login-email-group');
            const phoneGroup = document.getElementById('login-phone-group');

            if (type === 'email') {
                emailToggle.style.background = '#4f46e5';
                emailToggle.style.color = 'white';
                emailToggle.style.borderColor = '#4f46e5';
                phoneToggle.style.background = 'white';
                phoneToggle.style.color = '#64748b';
                phoneToggle.style.borderColor = '#e2e8f0';
                emailGroup.style.display = 'block';
                phoneGroup.style.display = 'none';
                document.getElementById('login-email').required = true;
                document.getElementById('login-phone').required = false;
            } else {
                phoneToggle.style.background = '#4f46e5';
                phoneToggle.style.color = 'white';
                phoneToggle.style.borderColor = '#4f46e5';
                emailToggle.style.background = 'white';
                emailToggle.style.color = '#64748b';
                emailToggle.style.borderColor = '#e2e8f0';
                emailGroup.style.display = 'none';
                phoneGroup.style.display = 'block';
                document.getElementById('login-email').required = false;
                document.getElementById('login-phone').required = true;
            }
        }

      
        function toggleRegisterType(type) {
            currentRegisterType = type;
            const emailToggle = document.getElementById('register-email-toggle');
            const phoneToggle = document.getElementById('register-phone-toggle');
            const emailGroup = document.getElementById('register-email-group');
            const phoneGroup = document.getElementById('register-phone-group');

            if (type === 'email') {
                emailToggle.style.background = '#4f46e5';
                emailToggle.style.color = 'white';
                emailToggle.style.borderColor = '#4f46e5';
                phoneToggle.style.background = 'white';
                phoneToggle.style.color = '#64748b';
                phoneToggle.style.borderColor = '#e2e8f0';
                emailGroup.style.display = 'block';
                phoneGroup.style.display = 'none';
                document.getElementById('register-email').required = true;
                document.getElementById('register-phone').required = false;
            } else {
                phoneToggle.style.background = '#4f46e5';
                phoneToggle.style.color = 'white';
                phoneToggle.style.borderColor = '#4f46e5';
                emailToggle.style.background = 'white';
                emailToggle.style.color = '#64748b';
                emailToggle.style.borderColor = '#e2e8f0';
                emailGroup.style.display = 'none';
                phoneGroup.style.display = 'block';
                document.getElementById('register-email').required = false;
                document.getElementById('register-phone').required = true;
            }
        }

       
        function backToRegister(event) {
            event.preventDefault();
            document.getElementById('verify-phone-form').style.display = 'none';
            document.getElementById('register-form').classList.add('active');
            document.getElementById('modal-message').style.display = 'none';
        }

   
        async function handleVerifyPhone(event) {
            event.preventDefault();

            const code = document.getElementById('verify-code').value;
            const btn = document.getElementById('verify-btn');

            if (!pendingPhoneVerification) {
                showModalMessage('Erro: Nenhuma verificação pendente', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Verificando...';

            try {
                const response = await API.post('/api/verify-phone', {
                    phone: pendingPhoneVerification.phone,
                    code: code
                });

                const data = await response.json();

                if (data.success) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    token = data.token;
                    user = data.user;
                    pendingPhoneVerification = null;
                    showModalMessage('Telefone verificado com sucesso!', 'success');
                    setTimeout(() => {
                        closeLoginModal();
                        updateUI();
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }, 1000);
                } else {
                    showModalMessage(data.error || 'Código inválido', 'error');
                }
            } catch (error) {
                showModalMessage('Erro ao verificar código: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Verificar';
            }
        }

        
        async function resendPhoneCode(event) {
            event.preventDefault();

            if (!pendingPhoneVerification) {
                showModalMessage('Erro: Nenhuma verificação pendente', 'error');
                return;
            }

            try {
                const response = await API.post('/api/resend-phone-code', {
                    phone: pendingPhoneVerification.phone
                });

                const data = await response.json();

                if (data.success) {
                    showModalMessage('Código reenviado para seu WhatsApp!', 'success');
                } else {
                    showModalMessage(data.error || 'Erro ao reenviar código', 'error');
                }
            } catch (error) {
                showModalMessage('Erro ao reenviar código: ' + error.message, 'error');
            }
        }


        async function handleLogin(event) {
            event.preventDefault();

            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('login-btn');

            let identifier;
            if (currentLoginType === 'email') {
                identifier = document.getElementById('login-email').value;
            } else {
                const phoneNumber = document.getElementById('login-phone').value;
                identifier = '+55' + phoneNumber;
            }

            btn.disabled = true;
            btn.textContent = 'Entrando...';

            try {
                const response = await API.post('/api/login', {
                    email: currentLoginType === 'email' ? identifier : undefined,
                    phone: currentLoginType === 'phone' ? identifier : undefined,
                    password
                });

                const data = await response.json();

                if (data.success) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    token = data.token;
                    user = data.user;
                    showModalMessage('Login realizado com sucesso!', 'success');
                    setTimeout(() => {
                        closeLoginModal();
                        updateUI();
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }, 1000);
                } else {
                    showModalMessage(data.error, 'error');
                }
            } catch (error) {
                showModalMessage('Erro ao fazer login: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Entrar';
            }
        }

        let currentForgotType = 'email';
        let pendingPhoneReset = null;

        function toggleForgotType(type) {
            currentForgotType = type;
            const emailToggle = document.getElementById('forgot-email-toggle');
            const phoneToggle = document.getElementById('forgot-phone-toggle');
            const emailForm = document.getElementById('forgot-email-form');
            const phoneForm = document.getElementById('forgot-phone-form');
            const verifyForm = document.getElementById('forgot-verify-form');
            const subtitle = document.getElementById('forgot-subtitle');
            const messageDiv = document.getElementById('forgot-message');

            messageDiv.style.display = 'none';
            verifyForm.style.display = 'none';

            if (type === 'email') {
                emailToggle.style.background = '#4f46e5';
                emailToggle.style.color = 'white';
                emailToggle.style.borderColor = '#4f46e5';
                phoneToggle.style.background = 'white';
                phoneToggle.style.color = '#64748b';
                phoneToggle.style.borderColor = '#e2e8f0';
                emailForm.style.display = 'block';
                phoneForm.style.display = 'none';
                subtitle.textContent = 'Digite seu email para receber o link de recuperação';
            } else {
                phoneToggle.style.background = '#4f46e5';
                phoneToggle.style.color = 'white';
                phoneToggle.style.borderColor = '#4f46e5';
                emailToggle.style.background = 'white';
                emailToggle.style.color = '#64748b';
                emailToggle.style.borderColor = '#e2e8f0';
                emailForm.style.display = 'none';
                phoneForm.style.display = 'block';
                subtitle.textContent = 'Digite seu telefone para receber o código via WhatsApp';
            }
        }

        async function handleForgotPassword(event) {
            event.preventDefault();

            const email = document.getElementById('forgot-email').value;
            const btn = document.getElementById('forgot-btn');
            const messageDiv = document.getElementById('forgot-message');

            btn.disabled = true;
            btn.textContent = 'Enviando...';
            messageDiv.style.display = 'none';

            try {
                const response = await API.post('/api/forgot-password', { email });

                const data = await response.json();

                if (data.success) {
                    messageDiv.textContent = 'Link de recuperação enviado! Verifique seu email.';
                    messageDiv.className = 'message success';
                    messageDiv.style.display = 'block';
                    document.getElementById('forgot-email').value = '';
                } else {
                    messageDiv.textContent = data.error || 'Erro ao enviar link de recuperação';
                    messageDiv.className = 'message error';
                    messageDiv.style.display = 'block';
                }
            } catch (error) {
                messageDiv.textContent = 'Erro ao processar solicitação: ' + error.message;
                messageDiv.className = 'message error';
                messageDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Enviar Link de Recuperação';
            }
        }

        async function handleForgotPasswordPhone(event) {
            event.preventDefault();

            const phone = document.getElementById('forgot-phone').value;
            const btn = document.getElementById('forgot-phone-btn');
            const messageDiv = document.getElementById('forgot-message');

            btn.disabled = true;
            btn.textContent = 'Enviando...';
            messageDiv.style.display = 'none';

            try {
                const response = await API.post('/api/forgot-password-phone', { phone: '+55' + phone });
                const data = await response.json();

                if (data.success) {
                    pendingPhoneReset = { phone: data.phone || '+55' + phone };

            
                    document.getElementById('forgot-phone-form').style.display = 'none';
                    document.getElementById('forgot-verify-form').style.display = 'block';
                    document.getElementById('forgot-subtitle').textContent = 'Digite o código e sua nova senha';

                    messageDiv.textContent = 'Código enviado para seu WhatsApp!';
                    messageDiv.className = 'message success';
                    messageDiv.style.display = 'block';
                } else {
                    messageDiv.textContent = data.error || 'Erro ao enviar código';
                    messageDiv.className = 'message error';
                    messageDiv.style.display = 'block';
                }
            } catch (error) {
                messageDiv.textContent = 'Erro ao processar solicitação: ' + error.message;
                messageDiv.className = 'message error';
                messageDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Enviar Código via WhatsApp';
            }
        }

        async function handleResetPasswordPhone(event) {
            event.preventDefault();

            const code = document.getElementById('forgot-verify-code').value;
            const password = document.getElementById('forgot-new-password').value;
            const confirmPassword = document.getElementById('forgot-confirm-password').value;
            const btn = document.getElementById('forgot-reset-btn');
            const messageDiv = document.getElementById('forgot-message');

            if (password !== confirmPassword) {
                messageDiv.textContent = 'As senhas não coincidem';
                messageDiv.className = 'message error';
                messageDiv.style.display = 'block';
                return;
            }

            if (!pendingPhoneReset) {
                messageDiv.textContent = 'Erro: Nenhuma recuperação pendente';
                messageDiv.className = 'message error';
                messageDiv.style.display = 'block';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Redefinindo...';
            messageDiv.style.display = 'none';

            try {
                const response = await API.post('/api/reset-password-phone', {
                    phone: pendingPhoneReset.phone,
                    code: code,
                    password: password
                });
                const data = await response.json();

                if (data.success) {
                    pendingPhoneReset = null;
                    messageDiv.textContent = 'Senha redefinida com sucesso! Você já pode fazer login.';
                    messageDiv.className = 'message success';
                    messageDiv.style.display = 'block';

            
                    document.getElementById('forgot-verify-code').value = '';
                    document.getElementById('forgot-new-password').value = '';
                    document.getElementById('forgot-confirm-password').value = '';
                    document.getElementById('forgot-phone').value = '';

           
                    setTimeout(() => {
                        document.getElementById('forgot-verify-form').style.display = 'none';
                        document.getElementById('forgot-phone-form').style.display = 'block';
                        document.getElementById('forgot-subtitle').textContent = 'Digite seu telefone para receber o código via WhatsApp';
                        closeForgotPasswordModal();
                        openLoginModal();
                    }, 2000);
                } else {
                    messageDiv.textContent = data.error || 'Erro ao redefinir senha';
                    messageDiv.className = 'message error';
                    messageDiv.style.display = 'block';
                }
            } catch (error) {
                messageDiv.textContent = 'Erro ao processar solicitação: ' + error.message;
                messageDiv.className = 'message error';
                messageDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Redefinir Senha';
            }
        }

        async function resendForgotCode(event) {
            event.preventDefault();

            if (!pendingPhoneReset) {
                return;
            }

            const messageDiv = document.getElementById('forgot-message');

            try {
                const response = await API.post('/api/forgot-password-phone', { phone: pendingPhoneReset.phone });
                const data = await response.json();

                if (data.success) {
                    messageDiv.textContent = 'Código reenviado para seu WhatsApp!';
                    messageDiv.className = 'message success';
                    messageDiv.style.display = 'block';
                } else {
                    messageDiv.textContent = data.error || 'Erro ao reenviar código';
                    messageDiv.className = 'message error';
                    messageDiv.style.display = 'block';
                }
            } catch (error) {
                messageDiv.textContent = 'Erro ao reenviar código: ' + error.message;
                messageDiv.className = 'message error';
                messageDiv.style.display = 'block';
            }
        }

    
        function maskCPF(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 11) value = value.slice(0, 11);
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            input.value = value;
        }

  
        function validateCPF(cpf) {
            cpf = cpf.replace(/\D/g, '');
            if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;

            let sum = 0;
            for (let i = 0; i < 9; i++) sum += parseInt(cpf.charAt(i)) * (10 - i);
            let rest = (sum * 10) % 11;
            if (rest === 10 || rest === 11) rest = 0;
            if (rest !== parseInt(cpf.charAt(9))) return false;

            sum = 0;
            for (let i = 0; i < 10; i++) sum += parseInt(cpf.charAt(i)) * (11 - i);
            rest = (sum * 10) % 11;
            if (rest === 10 || rest === 11) rest = 0;
            if (rest !== parseInt(cpf.charAt(10))) return false;

            return true;
        }

        async function handleRegister(event) {
            event.preventDefault();

            const name = document.getElementById('register-name').value.trim();
            // const cpf = document.getElementById('register-cpf').value; // CPF desativado
            const password = document.getElementById('register-password').value;
            const passwordConfirm = document.getElementById('register-password-confirm').value;
            const btn = document.getElementById('register-btn');

      
            if (!name || name.length < 3) {
                showModalMessage('Nome deve ter pelo menos 3 caracteres', 'error');
                return;
            }

            // Validação de CPF desativada
            // if (!validateCPF(cpf)) {
            //     showModalMessage('CPF inválido', 'error');
            //     return;
            // }

            if (password !== passwordConfirm) {
                showModalMessage('As senhas não coincidem', 'error');
                return;
            }

     
            if (currentRegisterType === 'email') {
                const email = document.getElementById('register-email').value.trim();
                if (!email) {
                    showModalMessage('Email é obrigatório', 'error');
                    return;
                }
                if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    showModalMessage('Email inválido', 'error');
                    return;
                }
            } else {
                const phoneNumber = document.getElementById('register-phone').value.trim();
                if (!phoneNumber) {
                    showModalMessage('Telefone é obrigatório', 'error');
                    return;
                }
                if (!/^[0-9]{10,11}$/.test(phoneNumber)) {
                    showModalMessage('Telefone inválido. Digite DDD + número (10 ou 11 dígitos)', 'error');
                    return;
                }
            }

            // const cpfClean = cpf.replace(/\D/g, ''); // CPF desativado

            btn.disabled = true;
            btn.textContent = 'Criando conta...';

            try {
                let response;
                let data;

                if (currentRegisterType === 'email') {

                    const email = document.getElementById('register-email').value.trim();
                    response = await API.post('/api/register', {
                        email,
                        password,
                        name,
                        // cpf: cpfClean, // CPF desativado
                        acceptedTermsAt: new Date().toISOString(),
                        termsVersion: '2026-01'
                    });
                    data = await response.json();

                    if (data.success) {
                        document.getElementById('register-form').querySelector('form').reset();
                        closeLoginModal();
                        showSuccessRegistration(email);
                        openLoginModal();
                        switchTab('login');
                        showModalMessage('Verifique seu email para ativar sua conta antes de fazer login.', 'success');
                    } else {
                        showModalMessage(data.error, 'error');
                    }
                } else {

                    const phoneNumber = document.getElementById('register-phone').value;
                    const phone = '+55' + phoneNumber;

                    response = await API.post('/api/register-phone', {
                        phone,
                        password,
                        name,
                        // cpf: cpfClean, // CPF desativado
                        acceptedTermsAt: new Date().toISOString(),
                        termsVersion: '2026-01'
                    });
                    data = await response.json();

                    if (data.success) {

                        pendingPhoneVerification = { phone };
                        document.getElementById('verify-phone-display').textContent = phone;
                        document.getElementById('register-form').classList.remove('active');
                        document.getElementById('verify-phone-form').style.display = 'block';
                        document.getElementById('verify-phone-form').classList.add('active');
                        showModalMessage('Código de verificação enviado para seu WhatsApp!', 'success');
                    } else {
                        showModalMessage(data.error, 'error');
                    }
                }
            } catch (error) {
                showModalMessage('Erro ao criar conta: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Criar Conta';
            }
        }


        async function handleSend(event) {
            event.preventDefault();

            const phoneNumber = document.getElementById('phone').value;
            const fullPhone = '+55' + phoneNumber;
            const message = document.getElementById('message').value;
            const btn = document.getElementById('send-btn');

           
            const hasAudio = currentAudioBase64 !== null;
            const hasMessage = message && message.trim().length > 0;

            if (!hasAudio && !hasMessage) {
                showMessage('send-message', 'Por favor, digite uma mensagem ou grave/envie um áudio.', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = hasAudio ? 'Enviando áudio...' : 'Enviando...';

            try {
                let response;
                let data;

                if (hasAudio) {
               
                    window.pendingAudioPhone = phoneNumber;

                    response = await API.post('/api/send-whatsapp-audio', {
                        phone: fullPhone,
                        audioBase64: currentAudioBase64,
                        mimetype: currentAudioMimetype,
                        caption: message || ''
                    }, token);

                    data = await response.json();

                    if (data.processing) {
              
                        showMessage('send-message', '🔄 Áudio em análise... Você pode continuar usando a plataforma. Será notificado quando o envio for concluído.', 'info');
                        document.getElementById('sendForm').reset();
                        removeAudio();
                    } else if (data.success) {
                        showMessage('send-message', 'Áudio enviado com sucesso! ✓', 'success');
                        document.getElementById('sendForm').reset();
                        removeAudio();
                        updateCreditsDisplay(data.whatsapp_credits, data.sms_credits);
                        loadHistory();
                        setTimeout(() => showSavePrompt(phoneNumber), 500);
                    } else {
                        showMessage('send-message', data.error, 'error');
                    }
                } else {
                    response = await API.post('/api/send-whatsapp', {
                        phone: fullPhone,
                        message: message
                    }, token);

                    data = await response.json();

                    if (data.success) {
                        showMessage('send-message', 'Mensagem enviada com sucesso! ✓', 'success');
                        const sentPhone = phoneNumber;
                        document.getElementById('sendForm').reset();
                        removeAudio();
                        updateCreditsDisplay(data.whatsapp_credits, data.sms_credits);
                        loadHistory();
                        setTimeout(() => showSavePrompt(sentPhone), 500);
                    } else {
                        if (data.moderationReason) {
                            showMessage('send-message', '⚠️ Mensagem bloqueada: Sua mensagem contém conteúdo inadequado e não pode ser enviada. Por favor, revise o texto e tente novamente.', 'error');
                        } else {
                            showMessage('send-message', data.error, 'error');
                        }
                    }
                }
            } catch (error) {
                console.error('[DEBUG] Erro completo:', error);
                showMessage('send-message', 'Erro: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Enviar Mensagem';
            }
        }


        function selectQuantity(qty) {
            selectedQuantity = qty;
            document.querySelectorAll('.quantity-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.target.closest('.quantity-option').classList.add('selected');
            document.getElementById('custom-quantity').value = qty;
            updateBonusPreview();
        }

        function updateBonusPreview() {
            const input = document.getElementById('custom-quantity');
            const preview = document.getElementById('bonus-preview');
            const qty = parseInt(input.value);

            if (qty && qty > 0) {
                const total = qty * 2;
                preview.textContent = `🎁 Você paga R$ ${qty},00 e recebe ${total} mensagens!`;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }

   
        let currentPixPaymentId = null;
        let pixPollingInterval = null;

        async function buyWithPix() {
            const quantity = parseInt(document.getElementById('custom-quantity').value) || selectedQuantity;

            if (!quantity || quantity < 1) {
                showAlert('Por favor, selecione ou digite uma quantidade', 'warning');
                return;
            }

            const btn = document.getElementById('buy-pix-btn');
            btn.disabled = true;
            btn.innerHTML = '<span style="font-size: 18px;">⏳</span> Gerando PIX...';

            try {
                const response = await API.post('/api/create-pix', { quantity }, token);
                const data = await response.json();

                if (data.success) {
                    showPixModal(data, quantity);
                } else {
                    showAlert(data.error || 'Erro ao gerar PIX', 'error');
                }
            } catch (error) {
                showAlert('Erro: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span style="font-size: 18px;">📱</span> Pagar com PIX';
            }
        }

        async function buyWithCard() {
            const quantity = parseInt(document.getElementById('custom-quantity').value) || selectedQuantity;

            if (!quantity || quantity < 1) {
                showAlert('Por favor, selecione ou digite uma quantidade', 'warning');
                return;
            }

            const btn = document.getElementById('buy-card-btn');
            btn.disabled = true;
            btn.innerHTML = '<span style="font-size: 18px;">⏳</span> Redirecionando...';

            try {
                const response = await API.post('/api/create-card-payment', { quantity }, token);
                const data = await response.json();

                if (data.success) {
                    window.location.href = data.checkoutUrl;
                } else {
                    showAlert(data.error || 'Erro ao criar pagamento', 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<span style="font-size: 18px;">💳</span> Cartão';
                }
            } catch (error) {
                showAlert('Erro: ' + error.message, 'error');
                btn.disabled = false;
                btn.innerHTML = '<span style="font-size: 18px;">💳</span> Cartão';
            }
        }

        function showPixModal(data, quantity) {
            currentPixPaymentId = data.paymentId;
            const total = quantity * 2;

            document.getElementById('pix-subtitle').textContent = `R$ ${quantity},00 = ${total} mensagens`;
            document.getElementById('pix-qr-image').src = `data:image/png;base64,${data.qrCodeBase64}`;
            document.getElementById('pix-code').textContent = data.qrCode;
            document.getElementById('pix-status').className = 'pix-status pending';
            document.getElementById('pix-status').innerHTML = '⏳ Aguardando pagamento...';

            document.getElementById('pix-modal').classList.add('show');

       
            startPixPolling();
        }

        function closePixModal() {
            document.getElementById('pix-modal').classList.remove('show');
            stopPixPolling();
            currentPixPaymentId = null;
        }

        function closePixModalOnBackdrop(event) {
            if (event.target.id === 'pix-modal') {
                closePixModal();
            }
        }

        function copyPixCode() {
            const pixCode = document.getElementById('pix-code').textContent;
            navigator.clipboard.writeText(pixCode).then(() => {
                showAlert('Código PIX copiado!', 'success');
            }).catch(() => {
               
                const textarea = document.createElement('textarea');
                textarea.value = pixCode;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showAlert('Código PIX copiado!', 'success');
            });
        }

        function startPixPolling() {
            if (pixPollingInterval) return;

            pixPollingInterval = setInterval(async () => {
                if (!currentPixPaymentId) {
                    stopPixPolling();
                    return;
                }

                try {
                    const response = await API.get(`/api/verify-payment/${currentPixPaymentId}`, token);
                    const data = await response.json();

                    if (data.paid) {
                        document.getElementById('pix-status').className = 'pix-status approved';
                        document.getElementById('pix-status').innerHTML = '✅ Pagamento confirmado!';
                        stopPixPolling();

                    
                        setTimeout(() => {
                            closePixModal();
                            loadUserData();
                            loadPaymentHistory();
                            showAlert('Pagamento confirmado! Seus créditos foram adicionados.', 'success');
                        }, 2000);
                    }
                } catch (error) {
                    console.error('Erro ao verificar pagamento:', error);
                }
            }, 5000); 
        }

        function stopPixPolling() {
            if (pixPollingInterval) {
                clearInterval(pixPollingInterval);
                pixPollingInterval = null;
            }
        }
    


        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            token = null;
            user = null;
            disconnectSocket(); 
            stopRepliesPolling();
            updateUI();
        }

        function connectSocket() {
            if (socket) return; 

            socket = io(API_CONFIG.baseURL, {
                transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                if (user && user.id) {
                    socket.emit('authenticate', user.id);
                }
            });

            socket.on('disconnect', () => {});

            socket.on('new-reply', (reply) => {
                loadReplies();

                loadHistory();
                showNewReplyNotification(reply);
            });

       
            socket.on('audio-moderation-result', (data) => {
                handleAudioModerationResult(data);
            });

     
            socket.on('user-blocked', (data) => {
                const phoneMasked = data.phone ? `****${data.phone.slice(-4)}` : 'desconhecido';
                showBlockNotification('bloqueou', phoneMasked, data.notificationId);
        
                loadNotifications();
            });

       
            socket.on('user-unblocked', (data) => {
                const phoneMasked = data.phone ? `****${data.phone.slice(-4)}` : 'desconhecido';
                showBlockNotification('desbloqueou', phoneMasked, data.notificationId);
       
                loadNotifications();
            });


            socket.on('announcement:new', (announcement) => {
                currentAnnouncement = announcement;
                showAnnouncementBanner(announcement);
          
                sessionStorage.removeItem('announcementDismissed');
                showAnnouncementModal(announcement);
            });

  
            socket.on('announcement:removed', () => {
                currentAnnouncement = null;
                hideAnnouncementBanner();
            });
        }

        function disconnectSocket() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
        }

        function showNewReplyNotification(reply) {
            const hasAudio = reply.audio_url && reply.audio_url.length > 0;
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
                color: white;
                padding: 15px 20px;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(79, 70, 229, 0.4);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                max-width: 350px;
            `;
            const icon = hasAudio ? '🎤' : '📱';
            const title = hasAudio ? 'Nova Resposta de Áudio!' : 'Nova Resposta!';
            notification.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 5px;">${icon} ${title}</div>
                <div style="font-size: 14px; opacity: 0.95;">${reply.message.substring(0, 100)}${reply.message.length > 100 ? '...' : ''}</div>
            `;

 
            if (!document.getElementById('notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(notification);


            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in forwards';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

   
        function handleAudioModerationResult(data) {
            if (data.success) {
          
                showAudioResultNotification(true, data.message || 'Áudio enviado com sucesso!');
                if (data.whatsapp_credits !== undefined) {
                    updateCreditsDisplay(data.whatsapp_credits, 0);
                }
                loadHistory();

       
                if (window.pendingAudioPhone) {
                    setTimeout(() => showSavePrompt(window.pendingAudioPhone), 500);
                    window.pendingAudioPhone = null;
                }
            } else if (data.blocked) {
            
                showAudioResultNotification(false, '⚠️ Áudio bloqueado: O conteúdo do seu áudio foi identificado como inadequado e não pode ser enviado.');
            } else {
          
                showAudioResultNotification(false, data.error || 'Erro ao processar áudio');
            }
        }

        function showAudioResultNotification(success, message) {
            const notification = document.createElement('div');
            const bgColor = success
                ? 'linear-gradient(135deg, #16a34a 0%, #22c55e 100%)'
                : 'linear-gradient(135deg, #dc2626 0%, #ef4444 100%)';
            const shadowColor = success
                ? 'rgba(22, 163, 74, 0.4)'
                : 'rgba(220, 38, 38, 0.4)';

            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 20px;
                border-radius: 12px;
                box-shadow: 0 10px 40px ${shadowColor};
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                max-width: 380px;
            `;

            const icon = success ? '✅' : '🚫';
            const title = success ? 'Áudio Enviado' : 'Áudio Bloqueado';

            notification.innerHTML = `
                <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">${icon} ${title}</div>
                <div style="font-size: 14px; opacity: 0.95; margin-bottom: 15px;">${message}</div>
                <button class="audio-result-btn" style="
                    background: rgba(255,255,255,0.2);
                    border: 1px solid rgba(255,255,255,0.4);
                    color: white;
                    padding: 8px 20px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: 600;
                    width: 100%;
                    transition: background 0.2s;
                ">Entendi</button>
            `;

            document.body.appendChild(notification);

            const btn = notification.querySelector('.audio-result-btn');
            btn.addEventListener('click', () => {
                notification.style.animation = 'slideOut 0.3s ease-in forwards';
                setTimeout(() => notification.remove(), 300);
            });
        }

        function showBlockNotification(action, phoneMasked, notificationId = null) {
            const notification = document.createElement('div');
            const isBlocked = action === 'bloqueou';
            const bgColor = isBlocked
                ? 'linear-gradient(135deg, #dc2626 0%, #ef4444 100%)'
                : 'linear-gradient(135deg, #16a34a 0%, #22c55e 100%)';
            const shadowColor = isBlocked
                ? 'rgba(220, 38, 38, 0.4)'
                : 'rgba(22, 163, 74, 0.4)';

            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 20px;
                border-radius: 12px;
                box-shadow: 0 10px 40px ${shadowColor};
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                max-width: 380px;
            `;

            const icon = isBlocked ? '🚫' : '✅';
            const title = isBlocked ? 'Você foi bloqueado' : 'Você foi desbloqueado';
            const message = isBlocked
                ? `O número ${phoneMasked} bloqueou você. Não será possível enviar mensagens para este número.`
                : `O número ${phoneMasked} desbloqueou você. Você pode enviar mensagens novamente.`;

            notification.innerHTML = `
                <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">${icon} ${title}</div>
                <div style="font-size: 14px; opacity: 0.95; margin-bottom: 15px;">${message}</div>
                <button class="block-notification-btn" style="
                    background: rgba(255,255,255,0.2);
                    border: 1px solid rgba(255,255,255,0.4);
                    color: white;
                    padding: 8px 20px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: 600;
                    width: 100%;
                    transition: background 0.2s;
                ">Entendi</button>
            `;

            document.body.appendChild(notification);

            const btn = notification.querySelector('.block-notification-btn');
            btn.addEventListener('mouseover', () => {
                btn.style.background = 'rgba(255,255,255,0.3)';
            });
            btn.addEventListener('mouseout', () => {
                btn.style.background = 'rgba(255,255,255,0.2)';
            });
            btn.addEventListener('click', async () => {
        
                if (notificationId && token) {
                    try {
                        await API.post(`/api/user/notifications/${notificationId}/read`, {}, token);
                        loadNotifications();
                    } catch (e) {
                        console.error('Erro ao marcar notificação como lida:', e);
                    }
                }

                notification.style.animation = 'slideOut 0.3s ease-in forwards';
                setTimeout(() => notification.remove(), 300);
            });
        }


        function startRepliesPolling() {
            if (repliesPollingInterval) return; 


            repliesPollingInterval = setInterval(() => {
                if (token) {
                    loadReplies();
                    loadHistory();
                }
            }, 60000);
        }

        function stopRepliesPolling() {
            if (repliesPollingInterval) {
                clearInterval(repliesPollingInterval);
                repliesPollingInterval = null;
            }
        }


        function showMessage(elementId, text, type) {
            const message = document.getElementById(elementId);
            message.innerHTML = text;
            message.className = `message ${type}`;
            message.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => {
                    message.style.display = 'none';
                }, 5000);
            }
        }

        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: '✓',
                error: '✕',
                warning: '⚠',
                info: 'ℹ'
            };

            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">×</button>
            `;

            container.appendChild(toast);

    
            setTimeout(() => {
                toast.style.animation = 'toastSlideOut 0.3s ease-in forwards';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        function showConfirm(message, options = {}) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const icon = document.getElementById('confirmModalIcon');
                const title = document.getElementById('confirmModalTitle');
                const messageEl = document.getElementById('confirmModalMessage');
                const cancelBtn = document.getElementById('confirmModalCancel');
                const confirmBtn = document.getElementById('confirmModalConfirm');

          
                messageEl.textContent = message;
                title.textContent = options.title || 'Confirmar ação';

          
                const type = options.type || 'danger';
                icon.className = `confirm-modal-icon ${type}`;

                if (type === 'danger') {
                    icon.textContent = '⚠';
                    confirmBtn.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                } else if (type === 'warning') {
                    icon.textContent = '⚠';
                    confirmBtn.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                } else {
                    icon.textContent = '?';
                    confirmBtn.style.background = 'linear-gradient(135deg, #6366f1 0%, #4f46e5 100%)';
                }


                cancelBtn.textContent = options.cancelText || 'Cancelar';
                confirmBtn.textContent = options.confirmText || 'Confirmar';

            
                modal.style.display = 'flex';

           
                const handleCancel = () => {
                    modal.style.display = 'none';
                    cleanup();
                    resolve(false);
                };

                const handleConfirm = () => {
                    modal.style.display = 'none';
                    cleanup();
                    resolve(true);
                };

                const cleanup = () => {
                    cancelBtn.removeEventListener('click', handleCancel);
                    confirmBtn.removeEventListener('click', handleConfirm);
                };

                cancelBtn.addEventListener('click', handleCancel);
                confirmBtn.addEventListener('click', handleConfirm);
            });
        }

        function showModalMessage(text, type) {
            const message = document.getElementById('modal-message');
            message.textContent = text;
            message.className = `message ${type}`;
            message.style.display = 'block';
        }

     

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('payment') === 'success' && token) {
            setTimeout(() => {
                loadUserData();
                loadPaymentHistory();
                showMessage('buy-message', 'Mensagens adicionadas com sucesso!', 'success');
            }, 1000);
        }

     

        async function handleAccessData() {
            if (!token) {
                showToast('Você precisa estar logado para acessar seus dados.', 'warning');
                return;
            }

            try {
                const response = await API.get('/api/user/data', token);

                if (!response.ok) throw new Error('Erro ao buscar dados');

                const result = await response.json();

                if (!result.success) throw new Error(result.error || 'Erro ao buscar dados');

                const { profile, credits, statistics } = result.data;

                const modal = document.getElementById('accessDataModal');
                const container = document.getElementById('accessDataContent');

             
                const cpfFormatted = profile.cpf
                    ? profile.cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4')
                    : 'Não informado';

                container.innerHTML = `
                    <div class="lgpd-data-section">
                        <h4>Informações Pessoais</h4>
                        <div class="lgpd-data-item">
                            <span class="lgpd-data-label">Nome:</span>
                            <span class="lgpd-data-value">${profile.name || 'Não informado'}</span>
                        </div>
                        <div class="lgpd-data-item">
                            <span class="lgpd-data-label">CPF:</span>
                            <span class="lgpd-data-value">${cpfFormatted}</span>
                        </div>
                        <div class="lgpd-data-item">
                            <span class="lgpd-data-label">Email:</span>
                            <span class="lgpd-data-value">${profile.email || 'Não informado'}</span>
                        </div>
                        <div class="lgpd-data-item">
                            <span class="lgpd-data-label">Telefone:</span>
                            <span class="lgpd-data-value">${profile.phone || 'Não informado'}</span>
                        </div>
                        <div class="lgpd-data-item">
                            <span class="lgpd-data-label">Créditos WhatsApp:</span>
                            <span class="lgpd-data-value">${credits.whatsapp || 0}</span>
                        </div>
                        <div class="lgpd-data-item">
                            <span class="lgpd-data-label">Data de cadastro:</span>
                            <span class="lgpd-data-value">${profile.created_at ? new Date(profile.created_at).toLocaleDateString('pt-BR') : 'N/A'}</span>
                        </div>
                    </div>
                    <div class="lgpd-data-section">
                        <h4>Estatísticas de Uso</h4>
                        <div class="lgpd-data-item">
                            <span class="lgpd-data-label">Mensagens enviadas:</span>
                            <span class="lgpd-data-value">${statistics.totalMessages || 0}</span>
                        </div>
                        <div class="lgpd-data-item">
                            <span class="lgpd-data-label">Transações realizadas:</span>
                            <span class="lgpd-data-value">${statistics.totalTransactions || 0}</span>
                        </div>
                        <div class="lgpd-data-item">
                            <span class="lgpd-data-label">Respostas recebidas:</span>
                            <span class="lgpd-data-value">${statistics.totalReplies || 0}</span>
                        </div>
                    </div>
                `;

                modal.style.display = 'block';
            } catch (error) {
                console.error('Erro ao acessar dados:', error);
                showToast('Erro ao carregar seus dados. Tente novamente.', 'error');
            }
        }

        async function handleExportData() {
            if (!token) {
                showToast('Você precisa estar logado para exportar seus dados.', 'warning');
                return;
            }

            try {
                const response = await API.get('/api/user/export-data', token);

                if (!response.ok) throw new Error('Erro ao exportar dados');

                const data = await response.json();

    
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `meus-dados-zapanonimo-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showToast('Seus dados foram exportados com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao exportar dados:', error);
                showToast('Erro ao exportar seus dados. Tente novamente.', 'error');
            }
        }

        async function handleCorrectData() {
            if (!token) {
                showToast('Você precisa estar logado para corrigir seus dados.', 'warning');
                return;
            }

            const nameInput = document.getElementById('correctName');
            const cpfInput = document.getElementById('correctCpf');
            const emailInput = document.getElementById('correctEmail');
            const phoneInput = document.getElementById('correctPhone');

           
            try {
                const response = await API.get('/api/user/data', token);
                const result = await response.json();

                if (result.success && result.data) {
                    const { profile } = result.data;

                 
                    if (profile.name) {
                        nameInput.value = profile.name;
                        nameInput.disabled = true;
                        nameInput.style.backgroundColor = '#f0f0f0';
                        nameInput.style.cursor = 'not-allowed';
                    } else {
                        nameInput.value = '';
                        nameInput.disabled = false;
                        nameInput.style.backgroundColor = '';
                        nameInput.style.cursor = '';
                    }

                  
                    if (profile.cpf) {
                        cpfInput.value = profile.cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                        cpfInput.disabled = true;
                        cpfInput.style.backgroundColor = '#f0f0f0';
                        cpfInput.style.cursor = 'not-allowed';
                    } else {
                        cpfInput.value = '';
                        cpfInput.disabled = false;
                        cpfInput.style.backgroundColor = '';
                        cpfInput.style.cursor = '';
                    }

               
                    if (profile.email) {
                        emailInput.value = profile.email;
                        emailInput.disabled = true;
                        emailInput.style.backgroundColor = '#f0f0f0';
                        emailInput.style.cursor = 'not-allowed';
                    } else {
                        emailInput.value = '';
                        emailInput.disabled = false;
                        emailInput.style.backgroundColor = '';
                        emailInput.style.cursor = '';
                    }

             
                    const sendPhoneCodeBtn = document.getElementById('sendPhoneCodeBtn');
                    const phoneVerificationGroup = document.getElementById('phoneVerificationGroup');
                    document.getElementById('phoneVerified').value = 'false';
                    phoneVerificationGroup.style.display = 'none';

                    if (profile.phone) {
                
                        const phoneNumber = profile.phone.replace(/^\+?55/, '');
                        phoneInput.value = phoneNumber;
                        phoneInput.disabled = true;
                        phoneInput.style.backgroundColor = '#f0f0f0';
                        phoneInput.style.cursor = 'not-allowed';
                        sendPhoneCodeBtn.style.display = 'none';
                    } else {
                        phoneInput.value = '';
                        phoneInput.disabled = false;
                        phoneInput.style.backgroundColor = '';
                        phoneInput.style.cursor = '';
                        sendPhoneCodeBtn.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
            }

            const modal = document.getElementById('correctDataModal');
            modal.style.display = 'block';
        }

        async function submitCorrectData(event) {
            event.preventDefault();

            const nameInput = document.getElementById('correctName');
            const cpfInput = document.getElementById('correctCpf');
            const emailInput = document.getElementById('correctEmail');
            const phoneInput = document.getElementById('correctPhone');
            const currentPassword = document.getElementById('correctCurrentPassword').value;
            const newPassword = document.getElementById('correctNewPassword').value;

            const body = {};

      
            if (!nameInput.disabled && nameInput.value.trim()) {
                const name = nameInput.value.trim();
                if (name.length < 3) {
                    showToast('O nome deve ter pelo menos 3 caracteres.', 'error');
                    return;
                }
                body.name = name;
            }

         
            if (!cpfInput.disabled && cpfInput.value.trim()) {
                const cpf = cpfInput.value;
                if (!validateCPF(cpf)) {
                    showToast('CPF inválido.', 'error');
                    return;
                }
                body.cpf = cpf.replace(/\D/g, '');
            }

  
            if (!emailInput.disabled && emailInput.value.trim()) {
                const email = emailInput.value.trim();
                if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    showToast('Email inválido.', 'error');
                    return;
                }
                body.email = email;
            }

          
            const phoneVerified = document.getElementById('phoneVerified').value === 'true';
            if (pendingPhoneForCorrection && phoneVerified) {
                body.phone = pendingPhoneForCorrection;
                body.phoneVerified = true; 
            } else if (!phoneInput.disabled && phoneInput.value.trim()) {
           
                showToast('Você precisa verificar o telefone antes de salvar. Clique em "Verificar".', 'error');
                return;
            }

        
            if (newPassword) {
                if (!currentPassword) {
                    showToast('Para alterar a senha, informe a senha atual.', 'error');
                    return;
                }
                body.currentPassword = currentPassword;
                body.newPassword = newPassword;
            }

    
            if (Object.keys(body).length === 0) {
                showToast('Nenhum dado para atualizar.', 'warning');
                return;
            }

            try {
                const response = await API.put('/api/user/data', body, token);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Erro ao atualizar dados');
                }

           
                if (data.profile) {
                    if (user) {
                        user.name = data.profile.name;
                        user.cpf = data.profile.cpf;
                        user.email = data.profile.email;
                        user.phone = data.profile.phone;
                        localStorage.setItem('user', JSON.stringify(user));
                    }
              
                    updateUI();
                }

                showToast('Dados atualizados com sucesso!', 'success');
                closeLgpdModal('correctDataModal');

            
                document.getElementById('correctCurrentPassword').value = '';
                document.getElementById('correctNewPassword').value = '';
            } catch (error) {
                console.error('Erro ao corrigir dados:', error);
                showToast(error.message || 'Erro ao atualizar seus dados. Tente novamente.', 'error');
            }
        }

        let pendingPhoneForCorrection = null;

        async function sendCorrectPhoneCode() {
            const phoneInput = document.getElementById('correctPhone');
            const phone = phoneInput.value.trim();

            if (!phone) {
                showToast('Digite um número de telefone.', 'error');
                return;
            }

            if (!/^[0-9]{10,11}$/.test(phone)) {
                showToast('Telefone inválido. Digite DDD + número (10 ou 11 dígitos).', 'error');
                return;
            }

            const btn = document.getElementById('sendPhoneCodeBtn');
            btn.disabled = true;
            btn.textContent = 'Enviando...';

            try {
                const response = await API.post('/api/user/send-phone-verification', { phone: '+55' + phone }, token);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Erro ao enviar código');
                }

                pendingPhoneForCorrection = '+55' + phone;
                document.getElementById('phoneVerificationGroup').style.display = 'block';
                document.getElementById('correctPhoneCode').value = '';
                document.getElementById('correctPhoneCode').focus();
                phoneInput.disabled = true;
                phoneInput.style.backgroundColor = '#f0f0f0';
                btn.style.display = 'none';

                showToast('Código enviado para o WhatsApp!', 'success');
            } catch (error) {
                console.error('Erro ao enviar código:', error);
                showToast(error.message || 'Erro ao enviar código. Tente novamente.', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Verificar';
            }
        }

        async function verifyCorrectPhoneCode() {
            const code = document.getElementById('correctPhoneCode').value.trim();

            if (!code) {
                showToast('Digite o código de verificação.', 'error');
                return;
            }

            if (!pendingPhoneForCorrection) {
                showToast('Erro: telefone não encontrado. Tente novamente.', 'error');
                return;
            }

            try {
                const response = await API.post('/api/user/verify-phone-update', {
                    phone: pendingPhoneForCorrection,
                    code: code
                }, token);

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Código inválido');
                }

        
                document.getElementById('phoneVerified').value = 'true';
                document.getElementById('phoneVerificationGroup').innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; color: #10b981; padding: 10px; background: #d1fae5; border-radius: 8px;">
                        <span style="font-size: 20px;">✓</span>
                        <span>Telefone verificado com sucesso!</span>
                    </div>
                `;

                showToast('Telefone verificado! Clique em "Salvar Alterações" para concluir.', 'success');
            } catch (error) {
                console.error('Erro ao verificar código:', error);
                showToast(error.message || 'Código inválido. Tente novamente.', 'error');
            }
        }

        let deleteConfirmationType = 'email'; 

        async function handleDeleteAccount() {
            if (!token) {
                showToast('Você precisa estar logado para excluir sua conta.', 'warning');
                return;
            }

            const toggleDiv = document.getElementById('deleteTypeToggle');
            const emailGroup = document.getElementById('delete-email-group');
            const phoneGroup = document.getElementById('delete-phone-group');
            const emailToggle = document.getElementById('delete-email-toggle');
            const phoneToggle = document.getElementById('delete-phone-toggle');
            const emailHint = document.getElementById('deleteEmailHint');
            const phoneHint = document.getElementById('deletePhoneHint');

            try {
                const response = await API.get('/api/user/data', token);
                const result = await response.json();

                if (result.success && result.data) {
                    const { profile } = result.data;
                    const hasEmail = !!profile.email;
                    const hasPhone = !!profile.phone;

           
                    if (hasEmail && hasPhone) {
                        toggleDiv.style.display = 'flex';
                        deleteConfirmationType = 'email';
                        toggleDeleteType('email');
                    } else if (hasEmail) {
                        toggleDiv.style.display = 'none';
                        emailGroup.style.display = 'block';
                        phoneGroup.style.display = 'none';
                        deleteConfirmationType = 'email';
                    } else if (hasPhone) {
                        toggleDiv.style.display = 'none';
                        emailGroup.style.display = 'none';
                        phoneGroup.style.display = 'block';
                        deleteConfirmationType = 'phone';
                    }

           
                    if (hasEmail) {
                        const emailParts = profile.email.split('@');
                        const maskedEmail = emailParts[0].substring(0, 3) + '***@' + emailParts[1];
                        emailHint.textContent = `Digite: ${profile.email}`;
                    }
                    if (hasPhone) {
                        const phoneClean = profile.phone.replace(/^\+?55/, '');
                        const maskedPhone = phoneClean.substring(0, 2) + '*****' + phoneClean.slice(-2);
                        phoneHint.textContent = `Digite apenas DDD + número: ${phoneClean}`;
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
            }

       
            document.getElementById('deleteEmailConfirmation').value = '';
            document.getElementById('deletePhoneConfirmation').value = '';
            document.getElementById('deletePassword').value = '';

            const modal = document.getElementById('deleteAccountModal');
            modal.style.display = 'block';
        }

        function toggleDeleteType(type) {
            deleteConfirmationType = type;
            const emailToggle = document.getElementById('delete-email-toggle');
            const phoneToggle = document.getElementById('delete-phone-toggle');
            const emailGroup = document.getElementById('delete-email-group');
            const phoneGroup = document.getElementById('delete-phone-group');

            if (type === 'email') {
                emailToggle.style.background = '#dc2626';
                emailToggle.style.color = 'white';
                emailToggle.style.borderColor = '#dc2626';
                phoneToggle.style.background = 'white';
                phoneToggle.style.color = '#64748b';
                phoneToggle.style.borderColor = '#e2e8f0';
                emailGroup.style.display = 'block';
                phoneGroup.style.display = 'none';
            } else {
                phoneToggle.style.background = '#dc2626';
                phoneToggle.style.color = 'white';
                phoneToggle.style.borderColor = '#dc2626';
                emailToggle.style.background = 'white';
                emailToggle.style.color = '#64748b';
                emailToggle.style.borderColor = '#e2e8f0';
                emailGroup.style.display = 'none';
                phoneGroup.style.display = 'block';
            }
        }

        async function submitDeleteAccount(event) {
            event.preventDefault();

            const password = document.getElementById('deletePassword').value;

            if (!password) {
                showToast('A senha é obrigatória para confirmar a exclusão.', 'error');
                return;
            }

      
            let confirmEmail = null;
            let confirmPhone = null;

            if (deleteConfirmationType === 'email') {
                confirmEmail = document.getElementById('deleteEmailConfirmation').value.trim();
                if (!confirmEmail) {
                    showToast('Digite seu email para confirmar a exclusão.', 'error');
                    return;
                }
            } else {
                const phoneInput = document.getElementById('deletePhoneConfirmation').value.trim();
                if (!phoneInput) {
                    showToast('Digite seu telefone para confirmar a exclusão.', 'error');
                    return;
                }
                confirmPhone = phoneInput; 
            }

            const confirmed = await showConfirm(
                'Todos os seus dados serão removidos permanentemente e não poderão ser recuperados.',
                {
                    title: 'Excluir conta permanentemente?',
                    type: 'danger',
                    confirmText: 'Sim, excluir minha conta',
                    cancelText: 'Cancelar'
                }
            );

            if (!confirmed) {
                return;
            }

            try {
                const body = { password };
                if (confirmEmail) body.confirmEmail = confirmEmail;
                if (confirmPhone) body.confirmPhone = confirmPhone;

                const response = await API.fetch('/api/user/delete-account', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Erro ao excluir conta');
                }

                showToast('Sua conta foi excluída com sucesso. Você será desconectado.', 'success');

             
                closeLgpdModal('deleteAccountModal');

        
                setTimeout(() => {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    token = null;
                    user = null;
                    disconnectSocket();
                    stopRepliesPolling();
                    updateUI();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }, 1500);

            } catch (error) {
                console.error('Erro ao excluir conta:', error);
                showToast(error.message || 'Erro ao excluir sua conta. Tente novamente.', 'error');
            }
        }

        function closeLgpdModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }

       
            if (modalId === 'correctDataModal') {
                pendingPhoneForCorrection = null;
                document.getElementById('phoneVerified').value = 'false';
            }
        }

     
        ['accessDataModal', 'correctDataModal', 'deleteAccountModal'].forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        closeLgpdModal(modalId);
                    }
                });
            }
        });


        function getOrCreateSessionId() {
            let sessionId = sessionStorage.getItem('sessionId');
            if (!sessionId) {
                sessionId = 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('sessionId', sessionId);
            }
            return sessionId;
        }

        async function trackAccess(page = 'home') {
            try {
                const sessionId = getOrCreateSessionId();
                await API.post('/api/track/access', { sessionId, page }, token);
            } catch (error) {
           
            }
        }

    
        trackAccess('home');

        updateUI();
    </script>

    <!-- Footer -->
    <footer class="site-footer" style="border-top: 1px solid #e2e8f0; padding-top: 30px;">
        <!-- Bloco de Confiança integrado -->
        <div style="display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; margin-bottom: 25px; padding: 0 20px;">
            <div style="display: flex; align-items: center; gap: 8px; color: #64748b; font-size: 13px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="#4f46e5">
                    <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/>
                </svg>
                <span>Moderação automática</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; color: #64748b; font-size: 13px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="#4f46e5">
                    <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
                </svg>
                <span>Registros conforme a lei</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; color: #64748b; font-size: 13px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="#4f46e5">
                    <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
                </svg>
                <span>Conforme LGPD</span>
            </div>
        </div>
        <div class="footer-social">
            <a href="https://www.instagram.com/zapanonimo2025" target="_blank" class="social-link instagram">
                <svg viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
                Instagram
            </a>
            <a href="https://www.tiktok.com/@zap.anonimo" target="_blank" class="social-link tiktok">
                <svg viewBox="0 0 24 24"><path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.44-3.37-3.65-5.71-.02-.5-.03-1-.01-1.49.18-1.9 1.12-3.72 2.58-4.96 1.66-1.44 3.98-2.13 6.15-1.72.02 1.48-.04 2.96-.04 4.44-.99-.32-2.15-.23-3.02.37-.63.41-1.11 1.04-1.36 1.75-.21.51-.15 1.07-.14 1.61.24 1.64 1.82 3.02 3.5 2.87 1.12-.01 2.19-.66 2.77-1.61.19-.33.4-.67.41-1.06.1-1.79.06-3.57.07-5.36.01-4.03-.01-8.05.02-12.07z"/></svg>
                TikTok
            </a>
        </div>
        <div class="footer-links">
            <a href="/fale-conosco">Fale Conosco</a>
            <a href="/privacy">Política de Privacidade</a>
            <a href="/terms">Termos de Uso</a>
        </div>
        <p class="footer-copyright">
            &copy; 2026 Zap Anônimo. Todos os direitos reservados.
        </p>
    </footer>

    <!-- Modal Favoritos -->
    <div id="favorites-modal" class="favorites-modal">
        <div class="favorites-modal-content">
            <div class="favorites-modal-header">
                <h3>⭐ Meus Favoritos</h3>
                <button class="favorites-modal-close" onclick="closeFavoritesModal()">&times;</button>
            </div>
            <div class="favorites-modal-body">
                <div id="favorites-list" class="favorites-list">
                    <!-- Lista de favoritos sera preenchida via JS -->
                </div>
                <div class="favorites-add-form">
                    <h4>Adicionar novo favorito</h4>
                    <input type="text" id="new-favorite-name" placeholder="Nome (ex: Joao)">
                    <input type="tel" id="new-favorite-phone" placeholder="Telefone (ex: 11999999999)" maxlength="11">
                    <button type="button" onclick="addFavorite()">Adicionar Favorito</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Prompt para salvar favorito -->
    <div id="save-favorite-prompt" class="save-favorite-prompt">
        <p>Deseja salvar este número nos favoritos?</p>
        <input type="text" id="save-favorite-name" placeholder="Nome do contato" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 12px; font-size: 14px;">
        <div class="save-favorite-prompt-buttons">
            <button class="btn-skip" onclick="closeSavePrompt()">Nao</button>
            <button class="btn-save" onclick="saveFavoriteFromPrompt()">Salvar</button>
        </div>
    </div>

    <!-- Modal de Confirmacao/Alerta Personalizado -->
    <div id="custom-modal" class="custom-modal-overlay">
        <div class="custom-modal-box">
            <div class="custom-modal-icon" id="custom-modal-icon"></div>
            <div class="custom-modal-title" id="custom-modal-title"></div>
            <div class="custom-modal-message" id="custom-modal-message"></div>
            <div class="custom-modal-buttons" id="custom-modal-buttons"></div>
        </div>
    </div>

    <!-- Modal PIX -->
    <div id="pix-modal" class="pix-modal">
        <div class="pix-modal-content">
            <div class="pix-modal-title">📱 Pagamento PIX</div>
            <div class="pix-modal-subtitle" id="pix-subtitle">Escaneie o QR Code ou copie o código</div>

            <div id="pix-status" class="pix-status pending">
                ⏳ Aguardando pagamento...
            </div>

            <div class="pix-qr-container">
                <img id="pix-qr-image" src="" alt="QR Code PIX">
            </div>

            <div class="pix-code-container" id="pix-code"></div>

            <button class="pix-copy-btn" onclick="copyPixCode()">
                📋 Copiar código PIX
            </button>

            <button class="pix-close-btn" onclick="closePixModal()">Fechar</button>
        </div>
    </div>

</body>
</html>
